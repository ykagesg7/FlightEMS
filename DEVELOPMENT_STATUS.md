# FlightAcademyTsx - 開発状況

このドキュメントでは、FlightAcademyTsxの現在の実装状況、課題、および今後の開発計画を記載しています。

## 関連ドキュメント
- [基本情報とセットアップ](./README.md)
- [技術仕様と実装詳細](./DOCUMENTATION.md)
- [開発参加ガイド](./CONTRIBUTING.md)

## 現在の実装状況

### ✅ 基本機能
- インタラクティブな地図表示（Leaflet.js）
- 基本レイヤー（地図、衛星写真）の切り替え
- オーバーレイレイヤー（空港、制限空域、高高度訓練空域など）の表示
- 空港、ウェイポイント、NAVAIDの表示と対話機能
- フライトパラメータ（速度、高度、出発時間）の設定と計算
- フライトプランの作成と管理（出発地、経由地、目的地）
- ウェイポイントのマップ上からの追加（ダブルクリックまたはポップアップのボタン）
- フライトサマリーの計算（総距離、ETE、ETA）
- ルートセグメントごとの詳細情報（速度、磁方位、高度、ETA）の表示
- コンパルサリーポイントと非コンパルサリーポイントの視覚的区別
- 出発空港の選択時に地上標高を自動設定
- 出発空港の選択時に地上気温を自動設定（WeatherAPIから取得）
- 気象データのキャッシュ機能（同一空港のデータを1時間キャッシュし、不要なAPI呼び出しを削減）

### ✅ 空港情報
- 空港アイコンの表示
- 空港クリック時の詳細情報ポップアップ
- 空港の気象情報取得と表示（WeatherAPI経由）
  - 天気状態（英語と日本語表記）
  - 温度と体感温度
  - 湿度
  - 風向風速（日本語変換対応）
  - 気圧
  - 視界
  - 降水量
  - UV指数
  - 日の出・日の入り時刻
  - 最終更新時刻
- 空港データに標高情報（Elev(ft)）を含み、フライトパラメータに活用
- 空港の気象データを使用した地上気温の自動設定
- キャッシュ機能による効率的な気象データの再利用

### ✅ 最近追加された機能（直近1ヶ月）
- 「ルートに追加」ボタンによるマップ上からのウェイポイント追加
- セグメントごとの詳細情報（CAS、磁方位、高度、ETA）の計算と表示
- 空港マーカーの改善（黒丸と制御圏の表示）
- 空港クリック時の気象情報表示機能の強化：
  - Leafletレイヤーグループ内のマーカーへの直接イベント設定
  - エラーハンドリングの改善とユーザー体験の向上
  - デバッグログの追加によるトラブルシューティングの容易化
- TASとMachの微調整機能：
  - TASを1kt単位で調整可能
  - Machを0.01単位で微調整可能
  - TAS/Machの変更がCASに自動反映
- UI/UXの改善：
  - NAVAIDセレクターとウェイポイントフォームのデザイン統一
  - 入力フィールドやボタンの視認性向上
  - ダークテーマの一貫性強化
- ウェイポイントデータの管理改善：
  - アルファベット別・地域別のデータ分割によるパフォーマンス最適化
  - 座標形式の統一（経度：ddd.dddd、緯度：dd.dddd）
  - IDによるアルファベット順ソート実装
  - name1フィールドの一貫性確保
  - 各種管理スクリプトの開発と整備（マージ、変換、追加、ソート、更新）
- コード品質の向上：
  - 未使用変数の削除
  - コードの最適化と整理
- 飛行場データの活用強化：
  - 出発空港選択時に地上標高を自動設定する機能追加
  - 出発空港選択時に地上気温を自動設定する機能追加
  - Optional chainingを活用した型安全なデータアクセス
  - 非同期データ取得中のローディング表示によるUX向上
  - Airport型とGeoJSON間のデータ連携を改善
  - TypeScriptの型安全性向上（@ts-ignoreの排除）
- 気象データキャッシュ機能の実装：
  - React Context APIを使用したグローバルキャッシュ状態管理
  - 同一空港のデータを1時間キャッシュし、API呼び出しを削減
  - PlanningタブとMapタブ間での切り替え時の重複データ取得を防止
  - API利用コストとパフォーマンスの最適化
  - コンポーネント間でのデータ共有を効率化
  - TypeScript型安全なキャッシュ実装
- マニューバービューア機能の実装：
  - 学習コンテンツ（LearningTab）に詳細図解ビューアを統合
  - スライド番号に対応したマニューバーアニメーションの表示
  - Canvas APIを使用した基本的な編隊飛行マニューバーの視覚化
  - Straight Join、Turning Join、Overshoot、Breakoutなどの機動の図示
  - 別ウィンドウでの表示機能

## 現在の技術的課題

### API管理
- **環境変数によるAPIキー管理**: 
  - 現在、Weather APIキーは`.env.local`ファイルで管理されていますが、一部環境で読み込みに問題が発生
  - フォールバックとしてハードコードされたキーを使用中（セキュリティ上の懸念あり）

### CORS対応
- WeatherAPIへの直接アクセスでCORS問題が発生する可能性あり
- 現在の対応は部分的であり、すべての環境で安定動作するか検証が必要

### UI/UX
- 空港アイコンの視認性向上が必要
- 気象情報ポップアップのデザイン最適化
- ✅ ルート計画セクションのデザイン統一（完了）：
  - NAVAIDセレクターとウェイポイントフォームのデザイン統一
  - 入力フィールドの一貫したスタイリング
  - ボタンデザインの改善とコントラスト強化
- ✅ 空港クリックイベントの信頼性（完了）：
  - レイヤーグループ内のマーカーに直接イベントハンドラを設定
  - デバッグログの追加によるトラブルシューティングの容易化
- マニューバービューアの機能強化：
  - 現在は基本的なアニメーションのみ実装
  - よりリアルな物理挙動の実装が必要
  - 3D表示やインタラクティブ要素の追加が必要

### パフォーマンス
- 大量のウェイポイントを扱う際のパフォーマンス最適化が必要
- GeoJSONデータの効率的な読み込みと処理の改善
- ✅ 複数の気象API呼び出しによるパフォーマンス低下の問題（完了）：
  - 気象データキャッシュ機能の実装により解決
  - 同一空港のデータを1時間キャッシュし、重複API呼び出しを削減
- マニューバーアニメーションのパフォーマンス最適化：
  - Canvas操作の効率化
  - 複雑な物理演算の最適化

### 型安全性
- ✅ 空港データ構造の型定義強化（完了）：
  - Airport型にproperties属性を追加し、GeoJSONデータの構造を正確に反映
  - optional chainingを活用した安全なデータアクセス
  - @ts-ignoreディレクティブの排除
- 一部のイベントハンドラやコンポーネント間のデータ受け渡しで改善の余地あり
- マニューバービューア関連の型定義整備：
  - アニメーションパラメータの型定義
  - フレーム更新関数の型安全性確保

### エラーハンドリング
- 気象データ取得失敗時のエラー表示をユーザーにも見えるように改善する必要あり
- ネットワーク接続が不安定な環境でのフォールバック対応を検討

## 今後の開発計画

### 短期計画（〜1ヶ月）
- **APIキー管理の改善**:
  - サーバーサイドプロキシの実装によるAPIキーの保護
  - 環境変数管理の安定化
- **UI改善**:
  - 空港アイコンのカスタマイズと視認性向上
  - 気象情報ポップアップのタブ化またはアコーディオン実装
  - ローディング状態の視覚表現を統一
- **ウェイポイント機能強化**:
  - ウェイポイントの編集と削除機能の強化
  - 各セグメントごとに異なる高度と速度の設定
- **ウェイポイントデータ管理**:
  - リファクタリングされたスクリプトのさらなる機能拡張
  - 追加・更新作業のワークフロー効率化
- **空港データの活用強化**:
  - 到着空港の標高情報の活用
  - 複数の滑走路情報の表示と活用
- ✅ **気象データの活用強化**（完了）:
  - 気象データのキャッシュ機能の実装
  - 取得したデータの共有・再利用による効率化
- **マニューバービューアの機能強化**:
  - より複雑な機動（オーバーシュート、衝突回避など）のアニメーション追加
  - パラメータを調整できるインタラクティブ要素の実装
  - 物理ベースのシミュレーション強化
  - 各位置関係での1番機の見え方（3D表示）の追加

### 中期計画（1〜3ヶ月）
- **フライトプラン機能の強化**:
  - フライトプランの保存と読み込み機能
  - ルート計画の詳細設定
  - 高度プロファイルの視覚化
  - 燃料計算の実装
- **気象情報の拡張**:
  - 予報データの表示（24時間、3日間）
  - 空域ごとの気象条件表示
  - METARとTAFの統合
  - 気温データを活用した高度別気温プロファイルの算出
- **ドキュメント整備**:
  - コード内のコメントとドキュメントの充実
  - 自動APIドキュメント生成の検討
- **マニューバーシミュレーション拡張**:
  - 完全な3D表示への移行
  - WebGLを活用したリアルタイムレンダリング
  - 実機の空力特性を反映した高精度シミュレーション
  - ユーザーによる操縦入力機能の実装
  - AR/VR対応の検討

### 長期計画（3ヶ月〜）
- **シミュレーション統合**:
  - フライトシミュレーターとの連携
  - リアルタイムデータの同期
- **コミュニティ機能**:
  - ユーザー間でのフライトプラン共有
  - コメントと評価システム
- **テスト強化**:
  - 自動テストの導入と整備
  - CI/CDパイプラインの充実
- **モバイル対応**:
  - レスポンシブデザインの完全対応
  - PWA（Progressive Web App）化
- **プリントアウト機能**:
  - フライトログと計画書の出力機能
- **高度な訓練シミュレーション**:
  - 複数のシナリオに基づく訓練モジュール
  - 自動評価システムの実装
  - 異常事態（緊急事態）のシミュレーション
  - 複数ユーザーによる同時訓練（マルチプレイヤー）

## セキュリティと環境変数

### 安全な環境変数管理への移行計画
現在の実装では、環境変数の読み込みに問題がある場合にハードコードされた値にフォールバックする仕組みがありますが、セキュリティ上の理由から以下の改善を計画しています：

1. **バックエンドプロキシの実装**:
   - フロントエンドからAPIキーを完全に除去
   - すべてのAPI呼び出しをバックエンドプロキシ経由に変更

2. **環境変数の一元管理**:
   - 本番環境: CI/CDパイプラインによる環境変数の安全な注入
   - 開発環境: .env.localの使用（gitignoreに含める）

3. **環境変数のバリデーション**:
   - アプリケーション起動時に必要な環境変数の存在確認
   - 適切なエラーメッセージの表示

## 課題管理と優先度

現在の課題は次の優先度で対応を計画しています：

**高優先度**:
1. APIキー管理の改善とセキュリティ強化
2. エラーハンドリングの改善
3. 空港アイコンの視認性向上
4. マニューバービューアの機能強化とインタラクティブ化

**中優先度**:
1. ウェイポイント機能の拡張
2. パフォーマンス最適化
3. 気象情報ポップアップのUI改善
4. 物理ベースのシミュレーション実装

**低優先度**:
1. ドキュメント整備
2. 型安全性のさらなる向上
3. 未使用コードの削除とリファクタリング
4. 3D表示機能の準備作業

---

最終更新日: 2025年4月8日 