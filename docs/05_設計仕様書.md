# FlightAcademyTsx 設計仕様書

## 📋 概要

このドキュメントは、FlightAcademyTsxプロジェクトの詳細な設計仕様、API仕様、データベース設計、UI/UX仕様について包括的に説明します。

**最終更新**: 2025年12月27日（Aboutページの認証状態に応じたナビゲーション実装）
**バージョン**: Design Specification v3.6

---

## 📚 記事システム設計（Phase 5実装済み）

### **記事メタデータ管理**

#### **ArticleMeta型定義**
```typescript
export type ArticleMeta = {
  type: 'article';
  title: string;
  slug: string;
  tags: string[];
  series?: string;
  order?: number;
  readingTime?: number;
  excerpt?: string;
  publishedAt?: string;
  author?: string;
  heroImage?: string;
};
```

#### **記事インデックスシステム**
- **ファイルベース管理**: `import.meta.glob`による動的記事収集
- **型安全なインデックス**: `ArticleIndexEntry`による構造化管理
- **キャッシュ機能**: パフォーマンス最適化のための記事インデックスキャッシュ
- **検索・フィルタリング**: タグ、シリーズ、著者による高度な検索機能

#### **記事フォーマット仕様**
- **参考書籍セクション**: 書籍引用記事の末尾に追加
- **書籍引用のガイドライン**: 適正な引用範囲、引用形式、Amazonアソシエイトリンク
- **著作権対策**: 映画・作品コンテンツのオマージュ表現、英語セリフの日本語要約

### **記事表示システム**

#### **コンポーネント構成**
- `ArticleDetailPage`: 記事詳細ページ
- `ReadingProgressBar`: 残り時間表示・進捗管理
- `MDXLoader`: 動的記事読み込み
- `CommentSection`: コメント機能
- `TableOfContents`: 目次・ナビゲーション
- `RelatedArticles`: 関連記事推薦

#### **主要機能**
- 読書進捗追跡、残り時間表示、目次生成、関連記事推薦、SEO最適化、コメント機能

### **学習進捗システム（2025年10月13日実装）**

#### **データベース設計**
```sql
CREATE TABLE learning_progress (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  content_id TEXT NOT NULL,
  completed BOOLEAN DEFAULT false,
  progress_percentage INTEGER DEFAULT 0 CHECK (progress_percentage >= 0 AND progress_percentage <= 100),
  last_position INTEGER DEFAULT 0,
  last_read_at TIMESTAMPTZ,
  read_count INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now(),
  CONSTRAINT learning_progress_user_id_content_id_key UNIQUE (user_id, content_id)
);
```

#### **進捗追跡機能**
- **useArticleProgress Hook**: ページ離脱時に進捗を自動保存（95%以上で完了判定）
- **ReadingProgressBar**: スクロール進捗追跡、5%未満は保存しない、95%以上で完了マーク
- **ProgressSidebar**: カテゴリー別進捗の集計と表示

#### **完了判定ロジック**
- 95%以上のスクロール: 自動的に`completed = true`
- 5%未満のスクロール: 保存しない（誤クリック防止）
- 5%〜95%: 進捗のみ保存、未完了として記録

### **記事コメント機能（2025年10月13日実装）**

#### **データベース設計**
```sql
CREATE TABLE learning_content_comments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  content_id TEXT NOT NULL REFERENCES learning_contents(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT learning_content_comments_user_content UNIQUE (id)
);
```

#### **機能仕様**
- **ログインユーザー**: コメント投稿（最大1000文字）、編集、削除、閲覧
- **ゲストユーザー**: 閲覧のみ
- **セキュリティ**: RLSポリシー適用、ユーザーIDによる権限チェック

### **シリーズ順次アンロック機能（2025年11月2日実装）**

#### **ロジック**
- **未ログインユーザー**: 各シリーズの1話のみ閲覧可能
- **ログインユーザー**: 直前話が読了で次話が解放
- **シリーズ外記事**: 常に解放

#### **実装コンポーネント**
- `useSeriesUnlock` Hook: シリーズ別記事リスト構築、解放判定
- `EnhancedArticleCard`: ロックオーバーレイ表示
- `ArticleDetailPage`: ロック時の遷移ガード

---

## 🎯 プロジェクト概要

### **目的**
Webベースの4択問題アプリケーション。最新の脳科学や学習理論を取り入れ、効率的な暗記と長期記憶への定着を支援。

### **技術スタック**
- **フロントエンド**: React, TypeScript, Vite, Tailwind CSS
- **バックエンド**: Supabase (PostgreSQL, Auth, Edge Functions)
- **開発環境**: Cursor IDE, GitHub Actions, Vercel

---

## 👥 ターゲットユーザー

### **ユーザーロール**
1. **Student (一般ユーザー)**: プロファイル編集、問題解答、学習履歴閲覧
2. **Teacher**: Studentの全権限 + Studentの学習情報閲覧
3. **Admin**: 全権限、ユーザー管理、問題管理、システム設定

---

## 🔧 機能要件

### **必須機能（MVPのコア）**
- ✅ ユーザー認証機能
- ✅ 問題カテゴリ機能
- ✅ カードデッキ機能
- ✅ 4択問題解答機能
- ✅ スコア・進捗管理機能

### **便利機能（MVPに含める学習支援機能）**
- ✅ 難易度レベル設定
- ✅ タイマー機能
- ✅ 復習機能（SRS）
- ✅ 解説文への画像添付機能
- ✅ カテゴリ別正答率レーダーチャート

### **脳科学的機能（SRS: 間隔反復学習システム）**
- ✅ 間隔反復スケジューリング（簡略版SM-2アルゴリズムベース）
- ✅ 復習問題の提示

### **AIパーソナライズ機能**
- ✅ 苦手カテゴリ推薦
- ✅ 学習状況の可視化

---

## 🗄️ データベース設計

### **主要テーブル定義**

#### **profiles テーブル**
```sql
CREATE TABLE profiles (
  id uuid REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
  username text UNIQUE,
  full_name text,
  avatar_url text,
  email text,
  roll text DEFAULT 'student'::text
);
```

#### **questions テーブル**
```sql
CREATE TABLE questions (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  deck_id uuid REFERENCES card_decks(id) ON DELETE CASCADE,
  question_text text NOT NULL,
  option_a text NOT NULL,
  option_b text NOT NULL,
  option_c text NOT NULL,
  option_d text NOT NULL,
  correct_answer char(1) NOT NULL CHECK (correct_answer IN ('A', 'B', 'C', 'D')),
  explanation text,
  difficulty_level integer DEFAULT 1,
  tags text[],
  image_urls text[],
  created_at timestamp DEFAULT now(),
  updated_at timestamp DEFAULT now()
);
```

#### **learning_records テーブル**
```sql
CREATE TABLE learning_records (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid REFERENCES profiles(id) ON DELETE CASCADE,
  question_id uuid REFERENCES questions(id) ON DELETE CASCADE,
  user_answer char(1) CHECK (user_answer IN ('A', 'B', 'C', 'D')),
  is_correct boolean,
  answer_time_seconds integer,
  session_id uuid,
  created_at timestamp DEFAULT now()
);
```

#### **user_question_srs_status テーブル**
```sql
CREATE TABLE user_question_srs_status (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id uuid REFERENCES profiles(id) ON DELETE CASCADE,
  question_id uuid REFERENCES questions(id) ON DELETE CASCADE,
  ease_factor real DEFAULT 2.5,
  interval_days integer DEFAULT 1,
  repetitions integer DEFAULT 0,
  next_review_date date DEFAULT CURRENT_DATE,
  last_review_date date,
  created_at timestamp DEFAULT now(),
  updated_at timestamp DEFAULT now(),
  UNIQUE(user_id, question_id)
);
```

---

## 🌐 API仕様

### **航空気象API（METAR/TAF）**

#### **エンドポイント: /api/aviation-weather**
- **リクエストパラメータ**: `type` (metar/taf), `icao` (空港コード)
- **実装**: NOAA Aviation Weather Center APIを使用、サーバーサイドプロキシでCORS回避
- **キャッシュ戦略**: 30分有効期間、React Context APIで管理
- **運用コスト**: 無料（NOAA API + Vercel Serverless Function無料枠）

#### **型定義**
```typescript
export interface METARData {
  icaoId: string;
  temp: number; // 摂氏
  wdir: number; // 風向（度）
  wspd: number; // 風速（ノット）
  fltCat: 'VFR' | 'MVFR' | 'IFR' | 'LIFR';
  // ... その他のフィールド
}

export interface TAFData {
  icaoId: string;
  rawTAF: string;
  // ... その他のフィールド
}
```

### **認証（Supabase Auth）**
- メールアドレスとパスワードによるサインアップ/サインイン
- パスワードリセット（Magic Link経由）
- セッション管理（JWTベース）

### **RPC（Remote Procedure Call）関数**

#### **主要関数**
- `get_quiz_session`: 学習セッション用の問題群を取得
- `submit_answer`: ユーザーの解答を記録し、SRS情報を更新
- `get_review_questions`: 復習すべき問題のリストを取得
- `get_recommended_categories`: 苦手カテゴリを推薦
- `complete_mission`: ミッション達成を記録し、XPを付与
- `import_deck_from_csv`: CSVデータからデッキと問題を一括インポート
- `get_category_performance_stats`: カテゴリ別パフォーマンスを取得

### **RLS（Row Level Security）ポリシー**

#### **基本方針**
- ユーザーは自身のデータのみフルアクセス可能
- 公開情報は読み取り可能
- Teacherは担当Studentの学習記録を読み取り可能
- Adminはほぼ全てのデータを読み書き可能

#### **パフォーマンス最適化**
- `auth.uid()`を`(select auth.uid())`に変更（各行での再評価を防止）
- 同じロール・アクションに対する複数のpermissiveポリシーを統合

---

## 🎨 UI/UX仕様

### **ヘッダー/ナビゲーション**
- LESSONSは`/learning`へのリンクのみ
- HOME（`/`）リンクを追加
- PLANNINGは`/planning`へ遷移

#### **MarketingLayoutヘッダー（2025年12月実装）**
- **ロゴ表示**: Yellow Robinロゴ画像（`/images/yellow-robin-logo.png`）をアイコンとして表示
- **ブランド名表示**: 「Whisky Papa」をメインタイトル、「Competition Aerobatic Team」をサブタイトルとして2行表示
  - メインタイトル: 太字、白文字
  - サブタイトル: 黄色系、小さいフォント、大文字、トラッキング拡張
- **HUDTimeDisplay**: ログイン状態に関係なく常時表示（デスクトップのみ）
- **Favicon**: `/images/favicon.ico`を設定

### **主要画面設計**

#### **Home.tsx（ランディングページ）背景画像設定（2025年12月実装）**
- **Hero Section**: `/images/ContentImages/Home/wp_cockpit_view.jpg` - パイロット視点の空中写真
  - グラデーションオーバーレイ: `from-whiskyPapa-black via-whiskyPapa-black/50 to-transparent`
  - 画像不透明度: 40%
- **Concept Section**: `/images/ContentImages/Home/wp_cockpit_instruments.jpg` - コックピット計器盤
  - 左側テキスト部分のみに背景画像を配置（右側の画像部分とは重ならない）
  - グラデーションオーバーレイ: `from-whiskyPapa-black/70 via-whiskyPapa-black/60 to-whiskyPapa-black/70`
  - 画像不透明度: 60%
- **Wingman Program Section**: `/images/ContentImages/Home/wp_aerobatic_flight2.jpg` - アクロバット飛行
  - グラデーションオーバーレイ: `from-whiskyPapa-black/75 via-whiskyPapa-black/65 to-whiskyPapa-black/75`
  - 画像不透明度: 80%
  - カード透過設定: `bg-whiskyPapa-black-light/60 backdrop-blur-sm`で背景画像が透けて見える
- **The Pilot's Narrative Section**: `/images/ContentImages/Home/wp_aerobatic_flight.jpg` - アクロバット飛行
  - グラデーションオーバーレイ: `from-whiskyPapa-black/70 via-whiskyPapa-black/60 to-whiskyPapa-black/70`
  - 画像不透明度: 45%
- **認証状態に応じたナビゲーション**: Hero Sectionの「JOIN our Formation」ボタンは、ログイン状態に応じて遷移先を変更
  - **ログインユーザー**: `/mission`へ遷移
  - **未ログインユーザー**: `/auth`へ遷移

#### **About.tsx（チーム紹介ページ）（2025年12月実装）**
- **THE CHIEF PILOTセクション**: 内海昌浩（MASA）の紹介とプロフィール画像
  - 画像フレーム: 丸形（`rounded-full`）で他のメンバーと統一
  - グロー効果: 特別感を演出する黄色のグローリング効果とシャドウ
  - 画像配置: テキストに近い位置に配置し、バランスを最適化
- **THE CREWセクション**: チームメンバー（Jun、Ogane、おしゅ士長、しゃどー）の紹介カード
  - 各メンバーの役割、名前、紹介文、Xアカウントリンクを表示
  - 丸形のプロフィール画像、ホバー時のエフェクト
- **EXTRA 300Lセクション**: 機体スペックのHUDスタイル表示
  - 背景画像: `/images/ContentImages/About/extra300.jpg`
  - HUDスタイルのステータス表示（STATUS: READY、FUEL: 100%）
- **SKY NOTESセクション（2025年12月実装）**: 認証状態に応じたナビゲーション
  - **ログインユーザー**: 「JOIN our Formation」ボタンで`/mission?tab=blog`へ遷移
  - **未ログインユーザー**: 「JOIN our Formation」ボタンで`/auth`へ遷移
  - Home.tsxと同じ認証状態判定ロジックを採用

#### **ダッシュボード画面**
- **Home/Dashboard統合**: ルートパス（`/`）でログイン状態に応じて自動切り替え
- **サマリーカード**: 全体進捗率、テスト正答率、連続学習日数
- **クイックアクション**: PLANNING、ARTICLE、LEARNING、TEST
- **Phase 1機能**: 今日の学習タスク、科目別レーダーチャート、学習履歴カレンダー

#### **プロフィール設定画面**
- **タブナビゲーション**: プロフィール、セキュリティ、ソーシャル、通知
- **プロフィールタブ**: アバターアップローダー、基本情報フォーム
- **セキュリティタブ**: パスワード変更フォーム、パスワード情報表示

### **レスポンシブデザイン対応**
- **ブレークポイント**: モバイル < 768px、タブレット 768px-1024px、デスクトップ > 1024px
- **モバイル最適化**: タッチフレンドリーなボタンサイズ、スワイプジェスチャー、ハンバーガーメニュー

---

## 🔒 非機能要件

### **パフォーマンス**
- 問題表示、解答送信のレスポンスタイムは1秒以内
- ダッシュボード表示は2秒以内

### **セキュリティ**
- ✅ Supabase RLS（Row Level Security）を活用
- ✅ パスワードは適切にハッシュ化（Supabase Auth標準）

### **ユーザビリティ**
- 直感的で分かりやすいUIデザイン
- モバイルフレンドリーなレスポンシブデザイン
- 主要な操作は3クリック以内で到達可能

---

## ✈️ Flight Planning機能設計

### **概要**
航空機の飛行計画を作成・管理するシステム。出発地・目的地の設定、経路上のウェイポイント追加、NAVAIDからのオフセット計算、飛行時間・距離の自動計算を提供。

### **主要コンポーネント**
- **RoutePlanning**: 出発空港・到着空港の選択、NAVAID/Waypointの追加、ウェイポイントリストの管理
- **NavaidSelector**: NAVAIDの選択とオフセット計算
- **WaypointSelector**: Waypointの選択と追加
- **WaypointForm**: DMS形式または10進数形式での座標入力

### **測地線計算システム**
- **calculateOffsetPoint関数**: 磁方位と距離でオフセットした地点の緯度経度を計算
- **磁気偏差補正**: 日本の平均磁気偏差8度を適用
- **測地線計算**: Haversine Formulaを使用

### **データ型定義**
```typescript
export interface Waypoint {
  id: string;
  name: string;
  type: 'custom' | 'navaid' | 'airport' | 'waypoint';
  coordinates: [number, number]; // GeoJSON format: [longitude, latitude]
  latitude: number;
  longitude: number;
  metadata?: WaypointMetadata;
}

export interface FlightPlan {
  departure?: Airport;
  arrival?: Airport;
  waypoints: Waypoint[];
  speed: number;
  altitude: number;
  totalDistance: number;
  ete: string;
  eta: string;
  // ... その他のフィールド
}
```

### **主要機能**
- **データ永続化**: JSON形式で飛行計画を保存・共有（PlanDocumentV1スキーマ）
- **機体プリセットシステム**: T-4練習機モック、燃料計算ロジック
- **空域→周波数の自動紐づけ**: レグの中点座標＋高度帯で該当ポリゴンを判定
- **印刷機能**: A4縦、2ページ構成（NavLog + Route Sketch）

---

## 🎨 テーマシステム設計

### **テーマ管理システム（v2.0: 固定スタイル化）**
- **HUD固定スタイル**: Dayモード（HUDグリーン `#39FF14`）を固定使用
- **テーマ切り替え機能**: 削除（固定スタイルに統一）
- **スタイル制御**: Tailwind CSSクラスとCSS変数で直接制御

### **Whisky Papa ブランド機能設計**

#### **Phase 1: Brand Foundation**
- **MarketingLayout**: 全ページ統一レイアウト（黒×黄色基調）
- **ブランドカラー**: Whisky Papa Yellow (#FFD700)、Whisky Papa Black (#121212)

#### **Phase 2: Gamification (Wingman Program)**
- **ランクシステム**: Spectator (0-299 XP)、Trainee (300-999 XP)、Wingman (1000+ XP)
- **ミッションタイプ**: one_time、daily、weekly
- **自動ミッション達成**: quiz_pass、article_read、plan_create

#### **Phase 3: Engagement (Shop & Gallery)**
- **Shop機能**: 商品管理、ランクロック機能、外部決済リンク
- **Gallery機能**: イベント管理、写真アップロード、いいね機能、Top3表示、タブ機能（公開/自分の投稿/管理）

**データベース設計（Gallery）**
```sql
CREATE TABLE gallery_events (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  slug TEXT NOT NULL UNIQUE,
  status TEXT NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'archived')),
  starts_at TIMESTAMPTZ,
  ends_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE fan_photos (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  image_url TEXT NOT NULL,
  caption TEXT,
  is_approved BOOLEAN DEFAULT false,
  is_featured BOOLEAN DEFAULT false,
  event_id UUID REFERENCES gallery_events(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE fan_photo_likes (
  photo_id UUID REFERENCES fan_photos(id) ON DELETE CASCADE,
  user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (photo_id, user_id)
);
```

**主要機能（Gallery）**
- イベント管理（アクティブイベントは1つのみ）
- いいね機能（承認済み写真のみ、自分の写真には不可、投票締切後は不可）
- Top3表示、ソート機能、タブ機能、過去イベント一覧、URL共有

---

## 🚀 開発環境セットアップ

### **前提ツール**
- Node.js 16.x以上
- npm 7.x以上
- Git
- Cursor IDE（推奨）

### **プロジェクトセットアップ手順**
1. リポジトリクローン
2. 依存関係インストール（`npm install`）
3. 環境変数設定（`.env.local`）
4. Supabase CLI設定
5. 開発サーバー起動（`npm run dev`）

---

## 📝 変更履歴

### **2025年12月27日 - Aboutページの認証状態に応じたナビゲーション実装**
- SKY NOTESセクションの「JOIN our Formation」ボタンを認証状態に応じて遷移先を変更
- ログインユーザー: `/mission?tab=blog`へ遷移
- 未ログインユーザー: `/auth`へ遷移
- Home.tsxと同じ認証状態判定ロジックを採用

### **2025年12月26日 - Gallery機能の段階的実装完了**
- Phase 1: 管理タブ拡張（AdminReviewPanel実装）
- Phase 2: アップロード機能復旧（Storage設定、UploadModal修正）
- Phase 3: いいね機能・Masonryレイアウト・自分の投稿タブ
- Phase 4: イベント制Gallery実装（イベント管理、投稿上限、いいねルール強化）

### **2025年12月24日 - 飛行計画機能拡張**
- JSON正本によるデータ永続化（PlanDocumentV1スキーマ）
- 機体プリセットシステム（T-4練習機モック）
- 空域→周波数の自動紐づけ
- A4印刷機能（PlanPrintViewコンポーネント）

### **2025年12月21日 - UI/UX統一・データベース修正**
- HUDテーマ削除、Whisky Papaテーマ統一
- ハンバーガーメニュー実装、Missionページ統合
- `complete_mission`関数修正、テスト結果保存修正

**詳細な変更履歴はGitのコミット履歴を参照してください。**

---

**最終更新**: 2025年12月27日
**バージョン**: Design Specification v3.6
**管理者**: FlightAcademy開発チーム
