# FlightAcademyTsx 技術開発ガイド

## 📋 概要

このドキュメントは、FlightAcademyTsxプロジェクトの技術詳細、開発環境、コントリビューション方法、高度な機能、パフォーマンス最適化について包括的に説明します。

**最新更新**: 2025年9月17日 - Articlesページテーマ統一・登録ボタン有効化
**バージョン**: Technical Development Guide v1.1

---

## 🏗️ 技術スタック詳細

### **アーキテクチャ概要**

#### **フロントエンド**
- **React 18**: Concurrent Mode、Suspense、useTransition
- **TypeScript**: 型安全性、開発効率向上
- **Vite**: 高速ビルドツール、動的チャンク分割

#### **バックエンド**
- **Supabase**: データベース、認証、リアルタイム機能
- **PostgreSQL**: リレーショナルデータベース

#### **地図・ナビゲーション**
- **Leaflet**: インタラクティブ地図ライブラリ
- **React-Leaflet**: React用Leafletラッパー
- **GeoJSON**: 地理データ形式

---

## 🛠️ フロントエンド技術スタック

### **コアフレームワーク**
```json
{
  "react": "^18.2.0",
  "react-dom": "^18.2.0",
  "typescript": "^5.0.0"
}
```

#### **React 18 の主要機能**
- **Concurrent Mode**: 非同期レンダリング
- **Suspense**: ローディング状態管理
- **useTransition**: 優先度付き更新
- **Automatic Batching**: 自動バッチング

### **ビルドツール**
```json
{
  "vite": "^4.4.0",
  "@vitejs/plugin-react": "^4.0.0"
}
```

#### **Vite の最適化機能**
- **動的チャンク分割**: コード分割の最適化
- **HMR (Hot Module Replacement)**: 高速開発
- **ESBuild**: 高速バンドリング

### **UI・スタイリング**
```json
{
  "tailwindcss": "^3.3.0",
  "react-select": "^5.7.0",
  "@headlessui/react": "^1.7.0"
}
```

#### **Tailwind CSS**
- **ユーティリティファースト**: 効率的なスタイリング
- **レスポンシブデザイン**: モバイルファースト
- **カスタムテーマ**: ダークモード対応

#### **検索・フィルタリング機能**
- **ArticleSearch**: 記事検索とタグフィルタリングの統合コンポーネント
- **正規化検索**: 全角半角・かな統一による日本語検索最適化
- **タグシステム**: sub_categoryベースの動的タグ抽出

#### **LearningページUI統合（更新）**
- **Articlesページ準拠**: 統一された検索・タグUIの実装
- **ダッシュボード維持**: 既存の「今日の復習」「続きから」「おすすめ」機能を保持
- **CPL学科コンテンツ**: 航空法規・航空工学・航空気象シリーズの統合表示（3.3.*を「航空気象」として自動タグ推定）

#### **新規共通UI（2025-08）**
- `components/common/FilterTabs.tsx`: A11y対応のカテゴリタブ（左右キー、`role="tablist"`）
- `components/common/SearchAndTags.tsx`: 検索＋タグ、URL同期と相性の良い `value`/`tags` props
- `components/common/ProgressRing.tsx`: SVGリング。`animejs` を遅延importしてストロークをアニメ
- `hooks/useAnimeInView.ts`: IntersectionObserver＋遅延importのスクロールイン演出
- `components/lessons/LessonCard.tsx`: 進捗リング＋完了バッジ＋関連TEST CTA。記事詳細は `/learning/:contentId` に遷移

### **状態管理**
```json
{
  "zustand": "^4.4.0",
  "@tanstack/react-query": "^4.29.0"
}
```

#### **Zustand**
- **軽量**: バンドルサイズ最小
- **型安全**: TypeScript対応
- **シンプル**: 学習コスト低

#### **React Query**
- **サーバー状態管理**: キャッシュ、同期
- **バックグラウンド更新**: 自動更新
- **エラーハンドリング**: 包括的エラー処理

---

## 📝 ファイルエンコーディング規約（重要）

### **エンコーディング統一**
- **必須**: すべてのコードファイル、MDXファイル、ドキュメントは「UTF-8（BOMなし）」で保存
- **禁止**: UTF-16、Shift-JIS、CP932エンコーディングの使用は禁止

### **MDXファイル規約**
- **フロントマター**: メタデータの統一形式
- **画像パス**: `/images/ContentImages/` ディレクトリ配下
- **コンポーネント**: カスタムMDXコンポーネントの活用

---

## 🗄️ データベース設計

### **学習コンテンツ管理**
```sql
-- learning_contents テーブル
CREATE TABLE learning_contents (
  id VARCHAR PRIMARY KEY,
  title VARCHAR NOT NULL,
  category VARCHAR NOT NULL,
  sub_category VARCHAR,  -- タグ機能用
  description TEXT,
  order_index INTEGER,
  parent_id VARCHAR,
  content_type VARCHAR DEFAULT 'article',
  is_published BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### **CPL学科コンテンツ構造**
```sql
-- 3.1.x 航空法規シリーズ
UPDATE learning_contents SET sub_category = '航空法規'
WHERE id IN ('3.1.1_AviationLegal0', '3.1.2_AviationLegal1', '3.1.3_AviationLegal2', '3.1.4_AviationLegal3');

-- 3.2.x 航空工学シリーズ
UPDATE learning_contents SET sub_category = '航空工学'
WHERE id IN ('3.2.1_PropellerTheory', '3.2.2_WingTheory', '3.2.3_StabilityControl',
             '3.2.4_HydraulicElectrical', '3.2.5_EngineTheory', '3.2.6_InstrumentSystem');
```

### **学習テストマッピング**
```sql
-- learning_test_mapping テーブル
CREATE TABLE learning_test_mapping (
  learning_content_id VARCHAR REFERENCES learning_contents(id),
  content_title VARCHAR NOT NULL,
  content_category VARCHAR NOT NULL,
  topic_category VARCHAR NOT NULL,
  subject_area VARCHAR NOT NULL,
  relationship_type VARCHAR DEFAULT 'direct',
  weight_score DECIMAL DEFAULT 1.0,
  difficulty_level INTEGER DEFAULT 1,
  estimated_study_time INTEGER DEFAULT 30,
  mapping_source VARCHAR DEFAULT 'manual',
  confidence_score DECIMAL DEFAULT 0.8,
  verification_status VARCHAR DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  PRIMARY KEY (learning_content_id, topic_category, relationship_type)
);
```

---

## ⚡ パフォーマンス最適化

### **React 18 Concurrent Features**
- **useTransition**: 非緊急更新の遅延処理
- **Suspense**: ローディング状態の管理
- **Automatic Batching**: 自動バッチング

#### **検索・フィルタリング最適化**
- **useMemo**: フィルタリング結果のメモ化
- **正規化関数**: 検索クエリの事前処理
- **動的タグ抽出**: 利用可能タグの効率的な計算

### **バンドルサイズ最適化**
- **動的インポート**: コード分割
- **Tree Shaking**: 未使用コードの除去
- **画像最適化**: WebP形式の活用

---

## 🧩 コンポーネント設計

### **再利用可能コンポーネント**
- **ArticleCard**: 記事カード表示
- **ArticleSection**: 記事セクション管理
- **ArticleSearch**: 検索・タグフィルタリング（Articles/Learning共通）
- **QuizComponent**: クイズ表示・解答
- **MDXLoader**: MDXコンテンツ表示

### **Learningページ専用コンポーネント**
- **RelatedTestButton**: 関連テストへの遷移
- **ReviewContentLink**: 復習コンテンツへのリンク
- **EnhancedLearningDashboard**: 学習ダッシュボード

---

## 🔄 状態管理

### **Zustand Store**
```typescript
// authStore.ts
interface AuthState {
  user: User | null;
  session: Session | null;
  loading: boolean;
}
```

#### **Learningページ状態管理**
```typescript
// LearningPage.tsx
interface LearningState {
  searchQuery: string;
  selectedTags: string[];
  filteredContents: LearningContent[];
  availableTags: string[];
}
```

### **React Query**
- **useQuery**: データ取得とキャッシュ
- **useMutation**: データ更新
- **useInfiniteQuery**: 無限スクロール

#### **学習コンテンツ取得**
```typescript
// useLearningProgress.ts
const { learningContents, isLoading, error } = useLearningProgress();

// CPL学科コンテンツフィルタリング（航空法規/航空工学/航空気象）
const cplLearningContents = useMemo(() => {
  return learningContents.filter(content =>
    content.is_published && content.category === 'CPL学科'
  );
}, [learningContents]);
```

---

## 🛡️ エラーハンドリング

### **Error Boundary**
- **EnhancedErrorBoundary**: 包括的エラー処理
- **フォールバックUI**: エラー時の代替表示
- **エラーログ**: 詳細なエラー情報の記録

#### **検索・フィルタリングエラー処理**
- **正規化エラー**: 検索クエリの不正文字処理
- **タグ抽出エラー**: sub_category未設定時のID接頭辞推定
- **フィルタ結果エラー**: 空結果時の適切なメッセージ表示

---

## 🔒 セキュリティ

### **認証・認可**
- **Supabase Auth**: ユーザー認証
- **RLS (Row Level Security)**: 行レベルセキュリティ
- **環境変数**: 機密情報の管理

#### **コンテンツアクセス制御**
- **is_published**: 公開状態の管理
- **category**: カテゴリ別アクセス制御
- **sub_category**: タグベースのフィルタリング

---

## 🧪 テスト戦略

### **単体テスト**
- **Vitest**: 高速テスト実行
- **React Testing Library**: コンポーネントテスト
- **TypeScript**: 型安全性テスト

#### **検索・フィルタリングテスト**
- **正規化関数テスト**: 日本語検索の正確性
- **タグ抽出テスト**: sub_categoryとID接頭辞の処理
- **フィルタリングテスト**: 複数条件の組み合わせ

---

## 🚀 デプロイメント

### **Vercel**
- **自動デプロイ**: GitHub連携
- **環境変数**: 本番環境設定
- **パフォーマンス監視**: Core Web Vitals

#### **データベース更新**
- **SupabaseMCP**: マイグレーション実行
- **SQL実行**: コンテンツ登録・更新
- **データ整合性**: スキーマ・データの同期

---

## 🔄 開発ワークフロー

### **Git Flow**
- **main**: 本番環境
- **develop**: 開発環境
- **feature**: 機能開発

#### **コンテンツ更新ワークフロー**
1. **MDX作成**: 新しい学習コンテンツの作成
2. **SQL生成**: データベース登録用SQLの作成
3. **SupabaseMCP実行**: データベースへの反映
4. **フロントエンド確認**: 表示・検索・タグ機能の動作確認

---

## 📊 パフォーマンス監視

### **Core Web Vitals**
- **LCP (Largest Contentful Paint)**: 最大コンテンツ描画時間
- **FID (First Input Delay)**: 初回入力遅延
- **CLS (Cumulative Layout Shift)**: 累積レイアウトシフト

#### **検索・フィルタリングパフォーマンス**
- **検索応答時間**: 100ms以内の検索結果表示
- **タグ抽出時間**: 利用可能タグの即座な計算
- **フィルタリング時間**: 複数条件での高速フィルタリング

---

## 📚 最近の実装（2025年8月17日〜）

### **Lessonページ検索・タグ機能統合**
- **ArticleSearch統合**: Articlesページと同等の検索・タグUIを実装
- **CPL学科コンテンツ対応**: 航空法規・航空工学シリーズの統合表示
- **ダッシュボード機能維持**: 既存の学習進捗機能を保持

### **CPL学科コンテンツ登録**
- **航空法規シリーズ**: 3.1.1〜3.1.4（4記事）
- **航空工学シリーズ**: 3.2.1〜3.2.6（6記事）
- **sub_category設定**: タグ機能のための適切な分類
- **航空気象シリーズ**: 3.3.1（W-1）, 3.3.2（W-2）を追加（カテゴリ `CPL学科`、サブカテゴリ `航空気象`）

### **SupabaseMCP活用**
- **データベース更新**: 10記事の一括登録・更新
- **マイグレーション実行**: 安全なスキーマ変更
- **データ整合性確認**: 登録後の動作確認

### **技術的改善点**
- **検索正規化**: 日本語検索の最適化
- **タグ動的抽出**: sub_categoryベースの自動タグ生成
- **フィルタリング最適化**: useMemoによるパフォーマンス向上

---

## 🔮 今後の技術ロードマップ

### **短期目標（1-2ヶ月）**
- **パフォーマンス最適化**: 検索・フィルタリングの高速化
- **ユーザビリティ向上**: 検索結果のハイライト機能
- **モバイル対応**: タグUIのレスポンシブ改善

### **中期目標（3-6ヶ月）**
- **高度な検索**: 全文検索エンジンの導入
- **レコメンデーション**: 学習履歴ベースの記事推薦
- **オフライン対応**: Service Workerによるキャッシュ

### **長期目標（6ヶ月以上）**
- **AI機能**: 自然言語検索の実装
- **パーソナライゼーション**: ユーザー別学習パス
- **分析機能**: 学習効果の可視化

---

## 📝 変更履歴

### **v1.1 (2025年9月17日) - Articlesページテーマ統一・登録ボタン有効化**

#### **🎨 テーマシステムの統一**
- **学習進捗ダッシュボードへのDay/Dark/Autoテーマ適用**
  - `ProgressSummaryHeader`、`ProgressSidebar`、`EnhancedArticleCard`、`ReadingTimeEstimate`コンポーネントで`theme`を`effectiveTheme`に統一
  - Dayテーマ：NavyBlue背景、白文字、HUDグリーン枠線
  - Darkテーマ：コックピット赤色照明デザイン（`hud-surface`、`shadow-red-900/20`）

#### **🎯 Articlesページデザイン統一**
- **HUDスタイルの適用**
  - `ArticleDashboard`：NavyBlue背景（`#0b1d3a`）、HUD枠線（`hud-line`）
  - 記事カード：`hud-surface`背景、`hover:bg-white/10`ホバー効果
  - 検索バー、タブ、統計カード：HUDスタイルに統一

#### **📊 学習進捗カードのデザイン統一**
- **統計カードのHUD化**
  - 読了記事数、学習時間、連続学習日数、今週の進捗カード
  - 今日の目標セクション、達成済みバッジ
  - カテゴリー別進捗、シリーズ別進捗、最近の活動カード

#### **🔍 分析カードのデザイン統一**
- **「更に詳しい学習分析を体験」カード**
  - Dayテーマ：`hud-surface hover:bg-white/10 shadow-green-900/10`
  - テキスト：`from-[#39FF14] to-green-600`グラデーション
  - ボタン：`hud-surface hud-text hover:bg-white/10`

- **「もっと詳しい分析を見る」カード**
  - Dayテーマ：`hud-surface hover:bg-white/10`
  - Darkテーマ：`hud-surface hover:bg-white/10 shadow-red-900/20`
  - ボタン：`hud-surface hud-text hover:bg-white/10`

#### **🔐 登録ボタンの有効化**
- **ログイン画面への遷移機能**
  - `ArticleDashboard`：`useNavigate`を追加、`showRegistrationModal`で`/auth`へ遷移
  - 全登録ボタン（「✨ 無料で登録」「無料で始める」「登録して見る」「もっと詳しい分析を見る」）が有効化
  - 既存の`/auth`ルートを使用した遷移実装

#### **🛠️ 技術的改善**
- **テーマ一貫性の確保**
  - 全コンポーネントで`effectiveTheme`の使用を統一
  - CSS変数（`--hud-primary`、`--hud-secondary`、`--hud-surface`）の活用
  - 条件付きレンダリングの最適化

- **エラーハンドリングの強化**
  - `ReferenceError: theme is not defined`の修正
  - 全コンポーネントでの`theme ===`を`effectiveTheme ===`に置換
  - Linterエラーの解消

#### **📈 パフォーマンス最適化**
- **コンポーネント最適化**
  - `useCallback`による関数のメモ化
  - 条件付きレンダリングの効率化
  - 不要な再レンダリングの防止

### **v1.0 (2025年8月17日) - Lessonページ検索・タグ機能統合**
- Lessonページの検索・タグ機能統合
- CPL学科コンテンツ登録
- SupabaseMCP活用

---

## 📖 参考資料

### **技術ドキュメント**
- [React 18 Documentation](https://react.dev/)
- [Supabase Documentation](https://supabase.com/docs)
- [Vite Documentation](https://vitejs.dev/)

### **設計パターン**
- **Atomic Design**: コンポーネント設計
- **Container/Presentational**: 状態管理パターン
- **Custom Hooks**: ロジックの再利用

### **ベストプラクティス**
- **TypeScript**: 型安全性の確保
- **Performance**: 最適化手法
- **Security**: セキュリティ対策
