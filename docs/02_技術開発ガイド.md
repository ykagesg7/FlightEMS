# FlightAcademyTsx 技術開発ガイド

## 📖 このドキュメントを読むべき人

- ✅ **AIアシスタント**: 開発環境のセットアップや実装の詳細を知りたい場合
- ✅ **開発者**: 開発を始める前に必読
- ✅ **コードレビュアー**: コーディング規約や実装方針を確認したい場合

**推奨読み順**: [docs/README.md](README.md) → このドキュメント

---

## 📋 概要

このドキュメントは、FlightAcademyTsxプロジェクトの技術詳細、開発環境、コントリビューション方法について説明します。

**最新更新**: 2026年1月（KaTeX数式記法サポート追加、PPL記事システム実装）
**バージョン**: Technical Development Guide v2.9

---

## 🏗️ 技術スタック詳細

### **アーキテクチャ概要**

#### **フロントエンド**
- **React 18**: Concurrent Mode、Suspense、useTransition
- **TypeScript**: 型安全性、開発効率向上
- **Vite**: 高速ビルドツール、動的チャンク分割
- **Tailwind CSS**: ユーティリティファーストのCSSフレームワーク

#### **バックエンド**
- **Supabase**: データベース、認証、リアルタイム機能
- **PostgreSQL**: リレーショナルデータベース

#### **地図・ナビゲーション**
- **Leaflet**: インタラクティブ地図ライブラリ
- **React-Leaflet**: React用Leafletラッパー
- **GeoJSON**: 地理データ形式

#### **外部API**
- **WeatherAPI.com**: 一般気象情報API（要APIキー）
- **NOAA Aviation Weather Center API**: 航空気象データAPI（認証不要・無料）
  - METAR（定時飛行場実況気象通報式）
  - TAF（飛行場予報）

#### **アニメーション・UI**
- **Framer Motion**: Marketingページ用のアニメーションライブラリ
- **Lucide React**: アイコンライブラリ

---

## 🛠️ 開発環境セットアップ

### **必要条件**
- Node.js 16.x以上
- npm 7.x以上
- Git

### **インストール手順**

1. **依存関係のインストール**
```bash
npm install
```

2. **環境変数の設定**

`.env.local`ファイルを作成し、以下の内容を追加：

```bash
# WeatherAPI.com（一般気象情報用）
VITE_WEATHER_API_KEY=your_weather_api_key

# Supabase
VITE_SUPABASE_URL=your_supabase_url
VITE_SUPABASE_ANON_KEY=your_supabase_anon_key
```

3. **開発サーバーの起動**

**推奨: ローカル開発環境（APIサーバー + フロントエンド）**

2つのターミナルを開いて以下を実行：

```bash
# ターミナル1: ローカルAPIサーバー起動
npm run dev:weather

# ターミナル2: フロントエンド開発サーバー起動
npm run dev
```

---

## 🛠️ フロントエンド技術スタック

### **コアフレームワーク**

#### **React 18 の主要機能**
- **Concurrent Mode**: 非同期レンダリング、優先度制御
- **Suspense**: データフェッチング、コード分割
- **useTransition**: 状態更新の優先度制御

### **ビルドツール**

#### **Vite の最適化機能**
- 高速HMR（Hot Module Replacement）
- 動的チャンク分割
- 本番ビルド最適化

#### **MDXプラグイン設定（2026年1月追加）**
- **@mdx-js/rollup**: MDXファイルの処理
- **remark-math**: Markdownの数式記法を解析
- **rehype-katex**: KaTeXで数式をレンダリング
- **katex**: 数式レンダリングライブラリ（CSSは`src/main.tsx`でインポート）
- 使用方法:
  - ブロック数式: `$$ 数式 $$`
  - インライン数式: `$ 数式 $`

### **UI・スタイリング**

#### **Tailwind CSS**
- ユーティリティファーストのCSSフレームワーク
- カスタムカラー: Whisky Papaブランドカラー（yellow/black）
- レスポンシブデザイン対応

### **デザインシステムとテーマ戦略（2025年12月実装）**

#### **デュアルテーマアーキテクチャ**
- **MarketingLayout**: Whisky Papaブランドテーマ（黒×黄色基調）
- **AppLayout**: HUD固定スタイル（Dayモード、HUDグリーン `#39FF14`）
- **テーマ切り替え機能**: 削除（固定スタイルに統一）

#### **共通UIコンポーネント (`src/components/ui/`)**
- `Button`: 統一されたボタンスタイル
- `Card`: カードコンポーネント
- `Input`: 入力フィールドコンポーネント

### **状態管理**

#### **Zustand**
- 軽量な状態管理ライブラリ
- グローバル状態の管理

#### **React Query**
- サーバー状態管理
- キャッシュ、再フェッチ、エラーハンドリング

---

## 📝 ファイルエンコーディング規約

### **エンコーディング統一**
- **UTF-8**: すべてのファイルでUTF-8エンコーディングを使用
- **改行コード**: LF（Unix形式）を推奨

### **MDXファイル規約**
- **フロントマター**: `export const meta`形式でメタデータを定義
- **エンコーディング**: UTF-8必須
- **数式記法**: KaTeXを使用したLaTeX形式の数式記法をサポート
  - ブロック数式: `$$ 数式 $$`
  - インライン数式: `$ 数式 $`
- **画像**: `<Image>`コンポーネントを使用（`@mdx`からインポート）
- **コメント**: JSXコメント形式（`{/* */}`）を使用（HTMLコメントは使用不可）

---

## 📁 コンポーネント構造

### **ハイブリッド方式の配置方針**

プロジェクトでは、コンポーネントを以下の2つのカテゴリに分類して配置しています：

#### **共通コンポーネント** (`src/components/`)
- **デザインシステムコンポーネント** (`ui/`): Button, Card, Typography など
- **マーケティング共通コンポーネント** (`marketing/`): RankBadge, MissionCard など
- **MDX関連共通コンポーネント** (`mdx/`): MDXLoader, MDXContent など
- **共通ユーティリティコンポーネント** (`common/`): FilterTabs, ProgressRing など

#### **ページ固有コンポーネント** (`src/pages/{page}/components/`)
- 各ページディレクトリ内の`components/`サブディレクトリに配置
- 例: `src/pages/articles/components/ArticleCard.tsx`
- 例: `src/pages/gallery/components/PhotoGrid.tsx`

詳細は [07_コンポーネント構造ガイド.md](07_コンポーネント構造ガイド.md) を参照してください。

---

## 🔧 主要コンポーネント・フック

### **Gallery機能（2025年12月実装）**

#### **主要コンポーネント**
- **PhotoGrid**: 写真グリッド表示（Masonryレイアウト、Lightbox機能）
- **UploadModal**: 写真アップロードモーダル（ドラッグ&ドロップ対応）
- **AdminEventPanel**: イベント管理パネル（管理者専用）
- **AdminReviewPanel**: 承認管理パネル（管理者専用）

#### **主要フック**
- **useGallery**: Galleryデータの取得・管理
  - イベント管理、いいね機能、写真承認/却下/おすすめ設定
  - Top3表示、ソート機能、タブ機能

### **記事システム**

#### **主要コンポーネント**
- **ArticleDetailPage**: 記事詳細ページ
- **ReadingProgressBar**: 残り時間表示・進捗管理
- **MDXLoader**: 動的記事読み込み
- **CommentSection**: コメント機能
- **TableOfContents**: 目次・ナビゲーション

#### **主要フック**
- **useArticleProgress**: 学習進捗管理、記事読了時のXP付与（2025年1月実装）
- **useArticleStats**: 記事統計データ管理（いいね、コメント、閲覧数）
- **useSeriesUnlock**: シリーズ順次アンロック機能

### **ゲーミフィケーションシステム（2025年1月実装）**

#### **主要コンポーネント**
- **RankBadge**: ランクバッジ表示（10段階対応）
- **RankBenefitsPage**: ランク特典一覧ページ
- **RankConfigPage**: 管理者用ランク条件設定ページ
- **XpConfigPage**: 管理者用経験値設定ページ
- **AchievementNotification**: 達成通知（ランクアップ、マイルストーン）

#### **主要フック**
- **useGamification**: ランク・XP・ミッション管理（10段階対応）
- **useStreak**: 連続学習日数管理（ストリークシステム）

#### **経験値システム**
- **記事読了XP**: カテゴリや記事ごとに異なるXP設定
- **記事読了ボーナス**: 初回読了ボーナス（+10 XP）
- **シリーズ完了ボーナス**: シリーズ完了時に1.5倍のXP
- **ストリークボーナス**: 連続学習日数に応じたXP倍率（最大2.5倍）

#### **ランクシステム（10段階）**
- **Fan** (0 XP) → **Spectator** (100 XP) → **Trainee** (200 XP) → **Student** (300 XP)
- **Apprentice** (400 XP) → **Pilot** (500 XP) → **Wingman** (600 XP) → **Ace** (700 XP)
- **Master** (800 XP) → **Legend** (900 XP)

#### **ランク条件管理**
- 各ランクに複数の条件を設定可能（XP、記事読了数、試験パス、購買履歴など）
- OR条件グループ対応（例: ウイングマンランクのロイヤリティ条件）
- 管理者が条件を動的に編集可能

### **Flight Planning機能**

#### **主要コンポーネント**
- **RoutePlanning**: 経路計画
- **NavaidSelector**: NAVAID選択
- **WaypointSelector**: Waypoint選択
- **PlanPrintView**: 印刷専用ビュー

#### **主要ユーティリティ**
- **calculateOffsetPoint**: 測地線計算（磁方位と距離でオフセット）
- **planDocument**: JSON正本のシリアライズ/デシリアライズ
- **airspace**: 空域判定と周波数取得

---

## 🚀 パフォーマンス最適化

### **コード分割**
- React.lazyを使用した動的インポート
- Suspenseコンポーネントでローディング状態を管理
- 手動チャンク分割でライブラリを分離

### **パフォーマンス改善結果**
- **メインバンドル**: 1,088.55 kB → 245.07 kB（77.5%削減）
- **分割チャンク**: react-vendor、map-vendor、supabase-vendor、ui-vendor、utils-vendor

---

## 📚 データベース設計

### **主要テーブル**
- **profiles**: ユーザープロファイル（ランク・XP含む）
- **questions**: 問題データ
- **learning_records**: 学習記録
- **user_question_srs_status**: SRS（間隔反復学習）ステータス
- **gallery_events**: Galleryイベント管理
- **fan_photos**: ユーザー投稿写真
- **fan_photo_likes**: いいねデータ
- **streak_records**: 連続学習日数追跡（2025年1月実装）
- **user_achievements**: マイルストーン報酬（2025年1月実装）
- **purchase_history**: 購買履歴・エンゲージメント追跡（2025年1月実装）
- **rank_requirements**: ランク条件管理（2025年1月実装）

### **RLS（Row Level Security）**
- ユーザーは自身のデータのみフルアクセス可能
- 公開情報は読み取り可能
- Adminはほぼ全てのデータを読み書き可能

---

## 🧪 テスト・CI/CD

### **テストフレームワーク**

#### **Vitest設定**
- **テスト環境**: jsdom（ブラウザ環境のシミュレーション）
- **カバレッジ**: v8プロバイダー、閾値設定（Lines: 50%, Functions: 50%, Branches: 40%, Statements: 50%）
- **テストファイル**: `src/__tests__/`ディレクトリに配置
- **テスト実行**: `npm test`（ウォッチモード）、`npm run test:run`（1回実行）

#### **テスト設定ファイル**
- `vitest.config.ts`: テスト設定（カバレッジ、タイムアウト、エイリアス）
- `src/setupTests.ts`: テストセットアップ（Supabase/Leafletモック）

### **CI/CDパイプライン（2025年1月実装）**

#### **GitHub Actionsワークフロー**
- **`.github/workflows/test.yml`**: 専用テストワークフロー
  - プルリクエスト・プッシュ時に自動実行
  - テストカバレッジレポートを自動生成
  - プルリクエストにカバレッジコメントを自動追加
- **`.github/workflows/verify-build.yml`**: ビルド検証ワークフロー
  - Lint、テスト、ビルドを順次実行
  - カバレッジレポートをアーティファクトとして保存

#### **CI/CDの動作**
1. **プルリクエスト作成時**: 自動的にテストが実行され、結果が表示
2. **プッシュ時**: main/master/developブランチへのプッシュ時に自動検証
3. **カバレッジレポート**: プルリクエストに自動コメントで表示

詳細は [プロジェクトルートのREADME.md](../README.md#cicd) を参照してください。

---

## 📝 変更履歴

### **2025年1月 - ゲーミフィケーションシステム拡張**
- **ランクシステム10段階化**: Fan → Spectator → Trainee → Student → Apprentice → Pilot → Wingman → Ace → Master → Legend
- **経験値（XP）システム**: 記事読了時のXP付与、カテゴリ別XP設定、ボーナスシステム
- **エンゲージメント追跡**: streak_records、user_achievements、purchase_historyテーブル追加
- **ランク条件管理**: rank_requirementsテーブルで複数条件・OR条件をサポート
- **ストリークシステム**: 連続学習日数追跡とXPボーナス倍率
- **管理者ページ**: ランク条件とXP設定を編集可能な管理画面
- **達成通知システム**: ランクアップ・マイルストーン達成時のアニメーション通知

### **2025年1月 - CI/CD統合・テスト設定改善**
- **CI/CDパイプライン追加**: GitHub Actionsワークフロー実装
- **テストカバレッジ**: プルリクエストに自動コメント機能追加
- **Vitest設定最適化**: カバレッジ閾値設定、タイムアウト設定
- **setupTests.ts修正**: 型エラー修正（`vi`のインポート追加）

### **2025年12月28日 - 記事進捗システム改善**
- **進捗計算方式の変更**: スクロール量ベースからセクションベース（見出しベース）に変更
- **目次と進捗の統合**: `useTableOfContents`フックに進捗計算機能を統合
- **進捗表示の改善**: 目次の下に円形メーターとパーセンテージ表示を追加
- **関連記事の扱い**: 目次には表示するが進捗計算からは除外
- **スクロール追随の改善**: `updateActiveHeading`関数でアクティブな見出しを正確に追跡

### **2025年12月26日**
- `docs/db`ディレクトリを削除（記事作成作業管理用ファイル）
- ドキュメント軽量化作業完了

### **2025年12月21日**
- ThemeContext削除完了、HUD固定スタイル統一
- 全27ファイルの`ThemeContext`依存を削除

### **2025年12月24日**
- 飛行計画エクスポート/インポート・燃料計算・印刷機能実装

### **2026年1月**
- KaTeX数式記法サポート追加（remark-math, rehype-katex）
- PPL記事システム実装開始（PPL-1-1-1, PPL-1-1-2, PPL-1-1-3作成完了）
- シリーズ順次アンロック機能の確認・動作確認

**詳細な変更履歴はGitのコミット履歴を参照してください。**

---

## 📖 参考資料

### **技術ドキュメント**
- [React 18 Documentation](https://react.dev/)
- [Supabase Documentation](https://supabase.com/docs)
- [Vite Documentation](https://vitejs.dev/)
- [Tailwind CSS Documentation](https://tailwindcss.com/docs)

### **設計パターン**
- **Atomic Design**: コンポーネント設計
- **Container/Presentational**: 状態管理パターン
- **Custom Hooks**: ロジックの再利用

---

**最終更新**: 2025年1月（ゲーミフィケーションシステム拡張）
**バージョン**: Technical Development Guide v2.8
**管理者**: FlightAcademy開発チーム
