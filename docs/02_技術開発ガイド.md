# FlightAcademyTsx 技術開発ガイド

## 📋 概要

このドキュメントは、FlightAcademyTsxプロジェクトの技術詳細、開発環境、コントリビューション方法、高度な機能、パフォーマンス最適化について包括的に説明します。

**最終更新**: 2025年8月11日
**バージョン**: Technical Development Guide v1.0

---

## 🏗️ 技術スタック詳細

### **アーキテクチャ概要**

#### **フロントエンド**
- **React 18**: Concurrent Mode、Suspense、useTransition
- **TypeScript**: 型安全性、開発効率向上
- **Vite**: 高速ビルドツール、動的チャンク分割

#### **バックエンド**
- **Supabase**: データベース、認証、リアルタイム機能
- **PostgreSQL**: リレーショナルデータベース

#### **地図・ナビゲーション**
- **Leaflet**: インタラクティブ地図ライブラリ
- **React-Leaflet**: React用Leafletラッパー
- **GeoJSON**: 地理データ形式

---

## 🛠️ フロントエンド技術スタック

### **コアフレームワーク**
```json
{
  "react": "^18.2.0",
  "react-dom": "^18.2.0",
  "typescript": "^5.0.0"
}
```

#### **React 18 の主要機能**
- **Concurrent Mode**: 非同期レンダリング
- **Suspense**: ローディング状態管理
- **useTransition**: 優先度付き更新
- **Automatic Batching**: 自動バッチング

### **ビルドツール**
```json
{
  "vite": "^4.4.0",
  "@vitejs/plugin-react": "^4.0.0"
}
```

#### **Vite の最適化機能**
- **動的チャンク分割**: コード分割の最適化
- **HMR (Hot Module Replacement)**: 高速開発
- **ESBuild**: 高速バンドリング

### **UI・スタイリング**
```json
{
  "tailwindcss": "^3.3.0",
  "react-select": "^5.7.0",
  "@headlessui/react": "^1.7.0"
}
```

#### **Tailwind CSS**
- **ユーティリティファースト**: 効率的なスタイリング
- **レスポンシブデザイン**: モバイルファースト
- **カスタムテーマ**: ダークモード対応

### **状態管理**
```json
{
  "zustand": "^4.4.0",
  "@tanstack/react-query": "^4.29.0"
}
```

#### **Zustand**
- **軽量**: バンドルサイズ最小
- **型安全**: TypeScript対応
- **シンプル**: 学習コスト低

#### **React Query**
- **サーバー状態管理**: キャッシュ、同期
- **バックグラウンド更新**: 自動更新
- **エラーハンドリング**: 包括的エラー処理

---

## 📝 ファイルエンコーディング規約（重要）

### **エンコーディング統一**
- **必須**: すべてのコードファイル、MDXファイル、ドキュメントは「UTF-8（BOMなし）」で保存
- **禁止**: UTF-16、Shift-JIS、CP932エンコーディングの使用は禁止
- **理由**: Vite/BabelがBOM付きファイルを正しくパースできないため、ビルドエラーの原因となる

### **VS Code推奨設定**
```json
// .vscode/settings.json
{
  "files.encoding": "utf8",
  "files.autoGuessEncoding": false,
  "files.eol": "\n",
  "editor.codeActionsOnSave": { "source.organizeImports": "explicit" }
}
```

### **EditorConfig設定**
```ini
# .editorconfig
root = true

[*]
charset = utf-8
end_of_line = lf
insert_final_newline = true
trim_trailing_whitespace = true

[*.{ts,tsx,js,jsx,md,mdx,json}]
indent_style = space
indent_size = 2
```

### **BOM除去スクリプト**
```bash
# package.json に追加されるスクリプト
npm run lint:encoding  # BOM混入ファイルを検出
npm run fix:encoding   # BOMを自動除去
```

### **トラブルシューティング**
- **エラー**: `Unexpected character ''` → BOM混入の可能性
- **対処法**: ファイルをUTF-8（BOMなし）で再保存
- **確認方法**: VS Codeステータスバーでエンコーディング確認

---

## 📈 記事ページ最適化（Phase 2/3 の要点）

### UI/HUD 統一
- ArticlesページにHUDデザイン（`--hud-primary`, `--panel`等のトークン）を適用
- 最新記事カード・リストの発光/ホバー・枠線スタイル統一
- モバイルヘッダー追加（簡易ナビ + テーマ切替 + 認証）

### パフォーマンス最適化（Phase 3）
- 記事数が多いサブカテゴリに対し、仮想スクロール（`react-window`）を導入
- `react-virtualized-auto-sizer`を使用して幅を自動フィット
- カラム数をレスポンシブで自動切替（1/2/3列）

### 検索/ハイライト強化
- 正規化（NFKC + カタカナ→ひらがな）で一致精度を向上
- ハイライト色は淡い黄色背景（HUDテキスト色と衝突回避）

### アクセシビリティ
- カテゴリタブに`role=tablist`/`role=tab`、矢印キー操作対応
- セクション/リストに`role="region"/list/listitem`を付与

### 追加依存パッケージ
```json
{
  "react-virtualized-auto-sizer": "^1.0.7"
}
```

---

## 🗺️ 地図・ナビゲーション技術

### **Leaflet エコシステム**
```json
{
  "leaflet": "^1.9.0",
  "react-leaflet": "^4.2.0",
  "@types/leaflet": "^1.9.0"
}
```

#### **主要機能**
- **インタラクティブ地図**: ズーム、パン、クリック
- **マーカー管理**: 空港、ナビゲーション支援施設
- **ルート描画**: 飛行経路の可視化
- **レイヤー管理**: 複数レイヤーの重ね合わせ

### **地理データ形式**
```typescript
// GeoJSON 型定義
interface GeoJSONFeature {
  type: 'Feature';
  geometry: {
    type: 'Point' | 'LineString' | 'Polygon';
    coordinates: number[][];
  };
  properties: {
    name: string;
    type: string;
    [key: string]: any;
  };
}
```

---

## 🔒 認証・セキュリティ

### **現状システム**
- 認証はSupabase Auth（メール/パスワード認証）＋Zustandによる一元状態管理
- Context/Providerによる認証管理は廃止し、Zustand selectorの参照安定化を徹底
- 外部OAuth（Google等）は今後段階的に対応予定
- 認証関連の主要UI/ロジックは`AuthPage.tsx`・`AuthButton.tsx`に集約

### **環境変数管理**
```typescript
// 型安全な環境変数
interface ImportMetaEnv {
  readonly VITE_SUPABASE_URL: string;
  readonly VITE_SUPABASE_ANON_KEY: string;
  readonly VITE_WEATHER_API_KEY: string;
  readonly VITE_GEMINI_API_KEY: string;
  readonly VITE_GOOGLE_CLOUD_VISION_API_KEY: string;
  readonly VITE_GMAIL_SMTP_PASSWORD: string;
  readonly VITE_BREVO_API_KEY: string;
}
```

---

## 🧪 テスト・品質管理

### **テストフレームワーク**
```json
{
  "vitest": "^0.34.0",
  "@testing-library/react": "^13.4.0",
  "@testing-library/jest-dom": "^5.16.0"
}
```

#### **Vitest**
- **高速**: Viteベースの高速テスト
- **TypeScript対応**: ネイティブTSサポート
- **ESM対応**: モジュールシステム対応

#### **React Testing Library**
- **ユーザー中心**: ユーザー行動に基づくテスト
- **アクセシビリティ**: アクセシビリティテスト
- **実用的**: 実際の使用パターンに基づくテスト

### **コード品質**
```json
{
  "eslint": "^8.45.0",
  "@typescript-eslint/eslint-plugin": "^6.0.0",
  "@typescript-eslint/parser": "^6.0.0"
}
```

---

## 🧭 Lessons/Test 連携アップデート（2025-08）

### 変更概要
- Testページ: モード切替（Practice/Exam/Review）を導入し、以下を実装。
  - Exam: タイマー、即時解説ロック、時間切れ自動提出
  - Review: `user_unified_srs_status`に基づき「今日の復習」を出題
  - 問題パレット（番号ジャンプ）・フラグ機能（見直し用）
- Lessonsページ: ダッシュボード（今日の復習件数、直近の閲覧、弱点おすすめ）を表示。
- ルーティング: `/articles/:contentId` を追加し、`MDXLoader`で `src/content/<id>.mdx` を読込。

### 実装ポイント
- フロント
  - `src/components/QuizComponent.tsx`: `mode`/`showImmediateFeedback`/`showQuestionPalette`/`examDurationSec` を追加。Examタイマー、パレット、フラグを実装。
  - `src/pages/TestPage.tsx`: クエリ（subject/sub/count/mode/contentId）で出題切替。Review出題、マッピング出題（`v_mapped_questions`）を優先。
  - `src/pages/LearningPage.tsx`: SupabaseからSRS件数、最近の閲覧、弱点科目を取得し、ダッシュボードに反映。
  - `src/pages/ArticleDetailPage.tsx` + `src/App.tsx`: 記事詳細ルート追加。
- サーバー/DB
  - `user_unified_srs_status`（SRS）テーブル追加（RLS: 自ユーザーのみ）。
  - `v_mapped_questions` ビューで `learning_test_mapping` × `unified_cpl_questions` を結合。
  - `user_test_results` に `unified_question_id` を追加し、`unified_cpl_questions` へFK。

### 使用例
- 記事→関連テスト: `/test?contentId=<記事ID>&mode=practice&count=10`
- 今日の復習: `/test?mode=review&count=10`
- おすすめ科目（弱点）: `/test?subject=航空法規&count=10&mode=practice`

## 📊 パフォーマンス最適化

### **React 18 Concurrent Features**
```typescript
// Suspense 境界
<Suspense fallback={<LoadingSpinner />}>
  <HeavyComponent />
</Suspense>

// useTransition
const [isPending, startTransition] = useTransition();
startTransition(() => {
  setState(newState);
});
```

### **仮想化**
```json
{
  "react-window": "^1.8.0",
  "react-virtualized-auto-sizer": "^1.0.0"
}
```

### **パフォーマンス最適化実績**
- **バンドルサイズ削減**: 77.5%削減（1,088.55 kB → 245.07 kB）
- **チャンク分割**: react-vendor, map-vendor, supabase-vendor等
- **Core Web Vitals**: LCP < 2.5秒、FID < 100ms、CLS < 0.1達成

---

## 💻 開発環境セットアップ

### **必要条件**
- Node.js 16.x以上
- npm 7.x以上
- Cursor IDE (推奨)

### **開発環境の構築**

1. **リポジトリのクローン**
```bash
git clone https://github.com/yourusername/FlightAcademyTsx.git
cd FlightAcademyTsx
```

2. **依存関係のインストール**
```bash
npm install
```

3. **環境変数設定**
```bash
cp .env.example .env.local
# .env.local に必要な API キーを設定
```

4. **開発サーバーの起動**
```bash
npm run dev
```

### **プロジェクト構造**
```
FlightAcademyTsx/
├── docs/                   # ドキュメント
├── public/                 # 静的ファイル
│   ├── geojson/            # 地理データ
│   ├── maneuver/           # マニューバーアニメーション
│   └── images/             # 画像ファイル
├── scripts/                # ユーティリティスクリプト
├── src/                    # ソースコード
│   ├── components/         # Reactコンポーネント
│   ├── contexts/           # Reactコンテキスト
│   ├── hooks/              # カスタムフック
│   ├── types/              # TypeScript型定義
│   ├── utils/              # ユーティリティ関数
│   ├── pages/              # ページコンポーネント
│   └── App.tsx             # メインアプリケーション
├── .env.example            # 環境変数テンプレート
├── package.json            # プロジェクト依存関係
└── tsconfig.json           # TypeScript設定
```

---

## 🗄️ データベース接続

### **Supabase設定**
- **プロジェクト名**: FlightAcademy
- **プロジェクトID**: fstynltdfdetpyvbrswr
- **リージョン**: ap-northeast-1（東京）
- **PostgreSQLバージョン**: 15.8.1.085

### **主要テーブル構造**

#### **1. profiles** - ユーザープロファイル情報
```sql
CREATE TABLE profiles (
  id uuid REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  username text UNIQUE,
  full_name text,
  avatar_url text,
  email text,
  roll text DEFAULT 'Student'
);
```

#### **2. learning_contents** - 学習コンテンツ管理
```sql
CREATE TABLE learning_contents (
  id varchar PRIMARY KEY,
  title varchar NOT NULL,
  category varchar,
  description text,
  order_index integer,
  is_freemium boolean DEFAULT FALSE
);
```

#### **3. unified_cpl_questions** - CPL試験用4択問題
```sql
CREATE TABLE unified_cpl_questions (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  main_subject varchar,
  sub_subject varchar,
  question_text text NOT NULL,
  options jsonb,
  correct_answer varchar,
  explanation text,
  difficulty_level integer DEFAULT 1
);
```

### **データベースアクセス例**
```typescript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = 'https://fstynltdfdetpyvbrswr.supabase.co';
const supabaseKey = process.env.SUPABASE_KEY;
const supabase = createClient(supabaseUrl, supabaseKey);

// ユーザープロファイル取得
async function getUserProfiles() {
  const { data, error } = await supabase
    .from('profiles')
    .select('*')
    .eq('roll', 'Student')
    .limit(10);

  if (error) {
    console.error('Error fetching profiles:', error);
    return null;
  }
  return data;
}
```

---

## 🤝 コントリビューション方法

### **クイックスタート**

1. リポジトリをフォークする
2. フォークしたリポジトリをクローンする
3. 依存関係をインストールする：`npm install`
4. 環境変数を設定する：`.env.local`ファイルを作成
5. 開発サーバーを起動する：`npm run dev`

### **開発フロー**

1. **ブランチ作成**: `git checkout -b feature/あなたの機能名`
2. **変更実装**: コードの変更と機能追加
3. **品質確認**: `npm run lint` でコード品質チェック
4. **テスト実行**: `npm run test` でテスト実行
5. **コミット**: `git commit -m "機能の説明"`
6. **プッシュ**: `git push origin feature/あなたの機能名`
7. **プルリクエスト作成**: GitHubでPR作成

### **コーディング規約**

#### **命名規則**
- **コンポーネント**: PascalCase（例: `FlightParameters.tsx`）
- **関数**: camelCase（例: `calculateDistance`）
- **変数**: camelCase（例: `totalDistance`）
- **定数**: UPPER_SNAKE_CASE（例: `MAX_ALTITUDE`）

#### **TypeScript**
- 可能な限り`any`型を避ける
- 複雑なデータ構造には適切なインターフェイスを定義
- optional chainingを活用して型安全性を確保
- 非同期操作には適切なエラーハンドリングを実装

#### **スタイリング**
- Tailwind CSSのユーティリティクラスを活用
- レスポンシブデザインを考慮
- アクセシビリティガイドラインに従う
- ダークモード対応を実装

### **プルリクエストチェックリスト**

- [ ] コードはTypeScriptの型安全性に準拠している
- [ ] 新しいコンポーネントは命名規則に従っている
- [ ] 既存の機能が損なわれていないことを確認した
- [ ] 環境変数の変更がある場合は`.env.example`を更新した
- [ ] ドキュメントが更新されている（必要な場合）
- [ ] すべての不要なコンソールログが削除されている

---

## 🔧 高度な機能とトラブルシューティング

### **マニューバービューア機能**

編隊飛行などの複雑な機動を視覚的に理解するための教育ツールです。

#### **実装技術**
- HTML5 Canvas
- JavaScript（アニメーション処理）
- イベントリスナー（ユーザー操作）

#### **ファイル構造**
```
public/
└── maneuver/
    ├── straight_join.html
    ├── turning_join.html
    └── [新しいマニューバーファイル].html
```

#### **新しいマニューバーの追加**
```typescript
// src/components/LearningTab.tsx 内で更新
const getManeuverFile = (slideNum: number): string => {
  const maneuverMap: Record<number, string> = {
    5: '/maneuver/straight_join.html',
    7: '/maneuver/turning_join.html',
    // 新しいマニューバーマッピングを追加
    20: '/maneuver/your_new_maneuver.html',
  };
  return maneuverMap[slideNum] || '';
};
```

### **図表作成機能（Mermaid）**

MDXドキュメント内にインタラクティブな図表を埋め込む機能です。

#### **DiagramComponentの使用方法**
```jsx
<DiagramComponent
  chart={`
    graph TD
      A[出発空港] -->|離陸| B(上昇段階)
      B --> C{高度決定}
      C -->|巡航高度| D[巡航段階]
      D --> F[目的地到着]
  `}
  title="フライトフェーズの流れ"
  theme="forest"
/>
```

#### **サポートされている図表タイプ**
- フローチャート（TD: top-down、LR: left-right）
- シーケンス図
- クラス図
- 状態図
- ER図
- ガントチャート

### **JSONデータ検証システム**

#### **検証スキーマ例**
```json
// waypoint.schema.json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "type": { "type": "string", "enum": ["Feature"] },
    "properties": {
      "type": "object",
      "required": ["id", "name1", "lat", "lon"],
      "properties": {
        "id": { "type": "string", "pattern": "^[A-Z0-9]{1,5}$" },
        "lat": { "type": "number", "minimum": -90, "maximum": 90 },
        "lon": { "type": "number", "minimum": -180, "maximum": 180 }
      }
    }
  }
}
```

#### **検証スクリプトの使用**
```bash
node scripts/validateWaypoints.js public/geojson/waypoints.json
node scripts/fixWaypointData.js public/geojson/waypoints.json
```

---

## ⚡ パフォーマンス最適化計画

### **検出された問題**
- `'message' handler took 219ms/380ms` - メッセージハンドラーの実行時間過多
- `'setTimeout' handler took 221ms` - タイマーハンドラーの実行時間過多
- `'requestAnimationFrame' handler took 444ms` - アニメーションフレーム処理の遅延
- `Forced reflow while executing JavaScript took 346ms` - 強制リフローによる遅延

### **最適化戦略**

#### **Phase 1: 即座に対応可能な最適化**

**1. イベントハンドラーの最適化**
```typescript
// Before: 重い処理を直接実行
const handleMessage = (event) => {
  heavyProcessing(); // 219ms-380ms
};

// After: 処理を分割・非同期化
const handleMessage = (event) => {
  updateUI(); // 軽量な処理のみ即座に実行

  requestIdleCallback(() => {
    heavyProcessing(); // 重い処理を非同期で実行
  });
};
```

**2. デバウンス・スロットリングの実装**
```typescript
const debouncedHandler = debounce((value) => {
  // 処理内容
}, 100);

const throttledHandler = throttle((value) => {
  // 処理内容
}, 16); // 60fps
```

**3. React コンポーネントの最適化**
```typescript
// Before: 不要な再レンダリング
const Component = ({ data }) => {
  return <div>{expensiveCalculation(data)}</div>;
};

// After: メモ化による最適化
const Component = memo(({ data }) => {
  const result = useMemo(() => expensiveCalculation(data), [data]);
  return <div>{result}</div>;
});
```

#### **Phase 2: 中期的な最適化**

**1. Web Workers の活用**
```typescript
const worker = new Worker('/workers/heavy-calculation.js');
worker.postMessage({ data: largeDataset });
worker.onmessage = (event) => {
  updateUI(event.data);
};
```

**2. 仮想化（Virtualization）の実装**
```typescript
import { FixedSizeList as List } from 'react-window';

const VirtualizedList = ({ items }) => (
  <List
    height={400}
    itemCount={items.length}
    itemSize={50}
    itemData={items}
  >
    {({ index, style, data }) => (
      <div style={style}>
        {data[index]}
      </div>
    )}
  </List>
);
```

### **パフォーマンス指標**
- **First Contentful Paint (FCP)**: < 1.5秒
- **Largest Contentful Paint (LCP)**: < 2.5秒
- **Cumulative Layout Shift (CLS)**: < 0.1
- **First Input Delay (FID)**: < 100ms

### **監視ツール**
```typescript
const measurePerformance = (name, fn) => {
  const start = performance.now();
  const result = fn();
  const end = performance.now();

  console.log(`${name} took ${end - start}ms`);
  return result;
};
```

---

## 🔍 トラブルシューティング

### **一般的な問題と解決策**

#### **1. 起動時のエラー**
```
問題: アプリケーションが起動しない、または白い画面のまま
解決策:
- node_modulesを削除し、npm installを再実行
- ブラウザキャッシュのクリア
- Viteのキャッシュをクリア: npm run clean:cache
```

#### **2. APIキーの問題**
```
問題: WeatherAPIへのリクエストが失敗する
解決策:
- .env.localファイルにVITE_WEATHER_API_KEYが正しく設定されているか確認
- APIキーの有効性を確認
- CORSの問題がある場合は、プロキシサーバーを使用
```

#### **3. マップが表示されない**
```
問題: レイヤーやマーカーが表示されない
解決策:
- ネットワーク接続を確認
- レイヤーコントロールで正しいレイヤーが選択されているか確認
- コンソールエラーを確認して特定の問題を特定
```

#### **4. React コンポーネントのエラー**

**未使用の関数や変数**
```
'functionName' is declared but its value is never read.
解決策: 不要な関数や変数を削除するか、コメントアウトする
```

**MDX CalloutBox未定義**
```
Uncaught Error: Expected component `CalloutBox` to be defined
解決策: MDXProvider の components オブジェクトに適切なマッピングを追加
```

**Hooks 使用順序エラー**
```
Warning: Do not call Hooks inside useEffect(...), useMemo(...), or other built-in Hooks.
解決策: Hooks はコンポーネントのトップレベルでのみ呼び出す
```

#### **5. mermaidライブラリの問題**
```
問題: Failed to resolve import "mermaid"
解決策:
- npm install mermaid を実行
- tsconfig.jsonに適切なパスマッピングを追加
- @ts-ignoreコメントが正しく配置されているか確認
```

---

## 🚀 AI・自動化ツール活用

### **Cursor.AIの活用方法**

#### **基本的なプロンプト例**
```
このTypeScriptコンポーネントをリファクタリングして、パフォーマンスを向上させてください。
```

```
以下のJSONデータを検証し、フォーマットエラーがあれば修正してください。
```

#### **高度なプロンプト例**
```
FadeInOnScroll.tsxコンポーネントを作成してください。このコンポーネントはビューポートに入った時に子要素をフェードインさせる機能を持ちます。IntersectionObserverを使用し、TypeScript型を適切に定義してください。
```

### **自動化できるタスク**

1. **コード生成**: 新規コンポーネントのテンプレート作成
2. **データ処理**: ウェイポイントデータの変換と検証
3. **ドキュメント生成**: コードからのAPIドキュメント生成

### **GitHub連携とコンフリクト解決**

- マージコンフリクトが発生した場合、AIアシスタントに「コンフリクトを解決してください」と指示
- コミット前のコードレビュー
- エラーの原因特定と修正案の提示

---

## 📈 品質管理・CI/CD

### **コード品質チェック**
```bash
# 静的解析実行
npm run lint

# 型チェック実行
npm run type-check

# テスト実行
npm run test
```

### **Git hooks統合**
```bash
# pre-commit hooks設定
npm install husky lint-staged --save-dev
npx husky install
npx husky add .husky/pre-commit "lint-staged"
```

### **CI/CD パイプライン（GitHub Actions）**
```yaml
name: CI/CD Pipeline
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run lint
      - run: npm run test
      - run: npm run build
```

---

## 📚 データ管理・運用

### **ウェイポイントデータの分割と統合**

#### **データ構造**
1. **アルファベット別**: `waypoints_A.json`、`waypoints_B.json`など
2. **地域別**: `waypoints_kanto.json`、`waypoints_kansai.json`など

#### **管理スクリプト**
```bash
# アルファベット別のファイルを統合
node scripts/mergeWaypoints.cjs

# 統合ファイルを地域別に分割
node public/geojson/split-waypoints-regions.mjs
```

### **座標形式の統一**
```typescript
// src/utils/coordinateUtils.ts
export function formatCoordinate(coordinate: number, isLongitude = false): number {
  const precision = 4;
  return parseFloat(coordinate.toFixed(precision));
}
```

---

## 🔮 今後の技術計画

本セクションの詳細な計画は、重複排除のため「03_計画改善ロードマップ.md」に集約しました。
- 短期/中期/長期の開発計画、成功指標、既知課題はロードマップを参照してください。

---

## 📞 サポート・コミュニティ

### **問題報告・機能要求**
- GitHub Issues での報告
- 詳細な再現手順の記載
- 環境情報の提供

### **技術的議論**
- Issue内での技術的議論を推奨
- コードレビューによる品質向上
- ベストプラクティスの共有

### **セキュリティガイドライン**
- APIキーなどの機密情報をコードに直接含めない
- ユーザー入力は適切にバリデーション
- プルリクエスト内で機密情報が公開されていないことを確認

---

## 🧩 Articles/MDX→Supabase 連携ガイド（最新）

### 概要
- 目的: `src/content` 配下の MDX 記事を Supabase の `learning_contents` に登録し、`/articles` で表示可能にする。
- 前提: 記事のファイル名（拡張子除く）が `learning_contents.id` と一致している必要がある。例: `src/content/1.13_DebriefingMentality.mdx` → `id = '1.13_DebriefingMentality'`。

### 必須フィールド（learning_contents）
- id: MDX のファイル名（拡張子なし）
- title: MDX の H1 タイトル
- category: 表示カテゴリ（Articles は『メンタリティー』『思考法』『操縦』を対象）
- description: 概要（任意）
- order_index: 並び順（数値）
- content_type: `'article'` を推奨
- is_published: 公開可否（Articles は true のみ表示）
- is_freemium: フリーミアム公開（任意）

### 登録（SupabaseMCP を利用）
- 対象プロジェクト: FlightAcademy（project_id: `fstynltdfdetpyvbrswr`）
- Upsert 例（実行済みサンプル）

```sql
INSERT INTO learning_contents (
  id, title, category, description, order_index,
  parent_id, content_type, is_published, is_freemium,
  created_at, updated_at
) VALUES (
  '1.13_DebriefingMentality',
  '【メンタリティー】夢をかなえるゾウ、ガネーシャの喝！愛の説教タイムや！【特濃・文字数無制限版】',
  'メンタリティー',
  'デブリーフィングを地獄の説教部屋から成長のパーティ会場に変えるための具体策と心理学。受け身の被告人から主体的な主演兼・監督へ。',
  113,
  null,
  'article',
  true,
  false,
  now(),
  now()
)
ON CONFLICT (id) DO UPDATE SET
  title = EXCLUDED.title,
  category = EXCLUDED.category,
  description = EXCLUDED.description,
  order_index = EXCLUDED.order_index,
  content_type = EXCLUDED.content_type,
  is_published = EXCLUDED.is_published,
  is_freemium = EXCLUDED.is_freemium,
  updated_at = now();
```

### フロント側の表示仕様
- 一覧は `ArticlesPage.tsx` が `useLearningProgress()` 経由で `learning_contents` を取得し、
  - `content.is_published === true`
  - `content.category` が『メンタリティー』『思考法』『操縦』のいずれか
  を満たすものを表示。
- 詳細表示は `MDXLoader` が `contentId` を `../../content/${contentId}.mdx` として動的 import。
  - したがって DB の `id` と MDX ファイル名（拡張子なし）は一致必須。
  - UUID 形式は未サポート（`MDXLoader` 側の仕様）。

### カテゴリ運用
- Articles の対象カテゴリは固定配列で定義（必要に応じて `ArticlesPage.tsx` の `articleCategories` を更新）。
- カテゴリを追加する場合は、表示フィルタと UI 表示文言の両方を併せて見直す。

### 一括同期ユーティリティ（任意）
- `src/utils/mdxToSupabase.ts` にて、ディレクトリスキャン→タイトル/説明抽出→`learning_contents` へ upsert。
- Node 実行前提（`fs`/`path` 依存）。ブラウザからは import しないこと。

### 検証チェックリスト
- MDX のファイル名と `learning_contents.id` が一致している。
- `category` が対象カテゴリに含まれる。
- `is_published = true` である。
- `/articles` に一覧カードが出ること、クリックで本文が表示されること。

**最終更新**: 2025年8月8日
**バージョン**: Technical Development Guide v1.0
**管理者**: FlightAcademy開発チーム

---

## ☁ 天気API（WeatherAPI）実装とデプロイ注意点（重要）

本プロジェクトでは、天気情報はクライアントから同一オリジンのサーバーレス関数を経由して取得します。

- クライアント呼び出し: `src/api/weather.ts` の `fetchWeather()` が `/api/weather?lat=...&lon=...` を叩く
- サーバーレス関数: `api/weather.ts`（Vercel Functions）
- ルーティング: `vercel.json` の `"src": "/api/(.*)", "dest": "/api/$1"`

### 本番（Vercel）でのモジュール形式の注意
リポジトリのルート `package.json` は `"type": "module"` ですが、Vercel の Node Functions は CommonJS で実行されるケースがあります。これにより、以下の実行時エラーが発生することがあります。

```
ReferenceError: exports is not defined in ES module scope
```

対策として、`api/` 配下のみ CommonJS を強制します。次のファイルを配置済みです。

```json
// api/package.json
{
  "type": "commonjs"
}
```

このファイルにより、`api/` ディレクトリ直下の関数は CJS として解釈され、上記クラッシュを回避できます。

### 必須環境変数（Production）
- `WEATHER_API_KEY`（Server Only）: weatherapi.com のAPIキー。未設定/不正だと `API_KEY_MISSING` / `API_KEY_INVALID` を返す
- `ALLOWED_ORIGIN`（任意）: CORS 許可オリジン。例: `https://<your-domain>.vercel.app`。未設定なら `*`

### 開発時の挙動
- Vite のプロキシで `/api` → `http://localhost:3001`（`vite.config.ts`）
- ローカル API は `scripts/dev-weather-server.ts` で起動可能
  - `npm run dev:weather`

### 動作確認（本番）
デプロイ後、ブラウザで以下のURLにアクセスして JSON が返ることを確認してください。

```
https://<本番ドメイン>/api/weather?lat=35.68&lon=139.76
```

エラー時は Vercel の Functions ログを参照し、`code` フィールド（`API_KEY_*`, `RATE_LIMIT_EXCEEDED`, `UPSTREAM_ERROR` など）で原因を特定します。
