# FlightAcademyTsx 運用保守ガイド

## 📖 このドキュメントを読むべき人

- ✅ **AIアシスタント**: 運用・保守作業を行う場合
- ✅ **運用担当者**: デプロイ手順やトラブルシューティングを確認したい場合
- ✅ **開発者**: 運用時の手順やメンテナンス方法を確認したい場合

**推奨読み順**: [docs/README.md](README.md) → [02_技術開発ガイド.md](02_技術開発ガイド.md) → このドキュメント

---

## 📋 概要

このドキュメントは、FlightAcademyTsxプロジェクトの運用、保守、トラブルシューティングについて説明します。

**最終更新**: 2025年12月26日
**バージョン**: Operations & Maintenance Guide v1.7

---

## 🎯 システム概要

### **目的**
- **自動化システム**: コード変更に伴うドキュメントの自動更新
- **品質保証**: ドキュメントの一貫性と正確性の確保
- **パフォーマンス最適化**: システム全体の性能向上
- **トラブルシューティング**: 問題の迅速な解決

### **主要機能**
- **ファイル監視**: ソースコードの変更を監視
- **自動更新**: 変更に基づくドキュメントの自動更新
- **検証機能**: ドキュメントの整合性チェック
- **Git hooks統合**: コミット前の自動実行

---

## 🔄 運用のポイント

### **テーマシステム統一（2025年12月21日）**
- **HUD固定スタイル**: Dayモード（HUDグリーン `#39FF14`）を固定使用
- **テーマ切り替え機能**: 削除（固定スタイルに統一）
- **スタイル制御**: Tailwind CSSクラスとCSS変数で直接制御

### **Supabase セキュリティLint対応**
- `public.v_mapped_questions` を SECURITY INVOKER 化
- 公開スキーマ上のバックアップテーブルを削除またはRLS有効化

### **管理者機能（ユーザーロール管理）**
- **画面**: `プロフィール > 管理者機能 > ユーザーロール管理`
- **機能**: `username/email`に対する部分一致検索、ロール変更
- **注意事項**: RLS（Row Level Security）が有効であること、Admin以外には表示されない

### **プロフィールページUI改善（2025年12月21日）**
- **入力フィールドのスタイル改善**: 編集モード/非編集モードの背景色・テキスト色を統一
- **パスワード更新日時の表示機能**: `password_updated_at`カラムを追加
- **入力フィールドアイコンの可視性改善**: 時間入力フィールドのアイコンを明るく表示

---

## ⚡ パフォーマンス改善

### **コード分割の実装**
- React.lazyを使用した動的インポート
- Suspenseコンポーネントでローディング状態を管理
- 手動チャンク分割でライブラリを分離

### **パフォーマンス改善結果**
- **メインバンドル**: 1,088.55 kB → 245.07 kB（77.5%削減）
- **分割チャンク**: react-vendor、map-vendor、supabase-vendor、ui-vendor、utils-vendor

---

## 🔧 トラブルシューティング

### **よくある問題と解決方法**

#### **ThemeContext参照エラー**
- **問題**: `ThemeContext`が未定義エラー
- **解決**: 全ファイルの`ThemeContext`依存を削除し、HUD固定スタイル（Dayモード）に統一（2025年12月21日完了）

#### **TypeScript型エラー**
- **問題**: `QuestionType`のインポートエラー
- **解決**: `src/constants.ts`のインポートパスを修正

#### **デバッグログの最適化**
- **問題**: 本番環境でも不要なコンソールログが出力される
- **解決**: 環境変数ベースのロガーユーティリティを作成、開発環境でのみデバッグ情報を表示

#### **Shopページのエラー（2026年1月6日修正）**
- **問題**: `ProductCard.tsx`で`Cannot read properties of undefined (reading 'displayName')`エラーが発生
- **原因**: `RANK_INFO`に存在しないランク（`spectator`、`trainee`）を参照していた
- **解決**:
  - `ProductCard.tsx`と`useShop.ts`でフォールバック処理を追加
  - `rankOrder`を`RANK_INFO`に存在するすべてのランクを含むように更新
  - デフォルトランクを`'spectator'`から`'fan'`に変更

#### **FlightPlanner地図タブのレイヤー表示問題（2026年1月6日修正）**
- **問題**: 地球を一周させるとレイヤーが表示されなくなる
- **原因**: LeafletのGeoJSONレイヤーが地図の表示範囲（bounds）に基づいてフィルタリングされ、経度のラップ処理が適切に行われていなかった
- **解決**: `MapContainer`に`worldCopyJump={true}`を追加し、経度のラップ処理を有効化

#### **ランクアップ進捗表示の問題（2026年1月6日修正）**
- **問題**: Missionページのランクアップ進捗が100%完了のまま固定される
- **原因**: 進捗計算ロジックが現在のXPを`nextRankXpRequired`で直接割っていたため、`nextRankXpRequired`が0の場合に100%固定される
- **解決**:
  - `useGamification.ts`の進捗計算ロジックを修正（現在のランクの必要XPと次のランクの必要XPの差を考慮）
  - `RANK_INFO`の`wingman`の`nextRankXpRequired`を修正（1500に更新）
  - PPL中間ランク（XPベースでないランク）の進捗表示を改善

---

## 📚 データベース管理

### **SupabaseMCPでのprofilesスキーマ確認手順**
1. プロジェクトIDを確認: `FlightAcademy (project_id: fstynltdfdetpyvbrswr)`
2. 次のSQLをMCPから実行:
```sql
select column_name, data_type, is_nullable, column_default
from information_schema.columns
where table_schema = 'public' and table_name = 'profiles'
order by ordinal_position;
```
3. 型同期: `src/types/database.types.ts` の `profiles.Row` と齟齬があれば修正

---

## 🚀 開発環境

### **前提ツール**
- Node.js 16.x以上
- npm 7.x以上
- Git
- Cursor IDE（推奨）

### **開発サーバー起動**
```bash
npm run dev
```

### **ビルド**
```bash
npm run build
```

---

## 💻 Git運用

### **コミットメッセージ規約**
- **言語**: 英語で記述（文字化け対策のため）
- **フォーマット**: Conventional Commits形式を推奨
  - `feat: Add new feature`
  - `fix: Fix bug in component`
  - `refactor: Refactor code structure`
  - `docs: Update documentation`
  - `chore: Update dependencies`
- **例**:
  ```bash
  git commit -m "feat: Add WhiskyPapa fan site branding"
  git commit -m "fix: Correct rank progress calculation"
  git commit -m "refactor: Simplify Home/About page structure"
  ```

---

## 🧪 テスト・CI/CD運用

### **テスト実行**
```bash
# ローカルでのテスト実行
npm test              # ウォッチモード
npm run test:run      # 1回実行
npm run test:coverage # カバレッジ生成
npm run test:ui       # UIモード
```

### **CI/CD運用**
- **自動実行**: プルリクエスト・プッシュ時に自動実行
- **カバレッジレポート**: プルリクエストに自動コメント
- **手動実行**: GitHub Actionsの「Run workflow」から実行可能

### **トラブルシューティング（テスト）**
- **テストが失敗する場合**: `npm run lint`で型エラーを確認
- **カバレッジが生成されない場合**: `npm run test:coverage`を手動実行
- **CI/CDが失敗する場合**: GitHub Actionsのログを確認

---

## 📝 変更履歴

### **2025年1月 - CI/CD統合**
- GitHub Actionsワークフロー追加（テスト・ビルド検証）
- テストカバレッジレポート自動生成機能追加

### **2025年12月26日**
- `docs/db`ディレクトリを削除（記事作成作業管理用ファイル）

### **2025年12月21日**
- HUDテーマ削除、Whisky Papaテーマ統一
- プロフィールページUI改善（入力フィールドスタイル、パスワード更新日時表示）

### **2025年12月24日**
- リポジトリ整理作業完了（未使用ファイルの退避）

### **2026年1月6日**
- Shopページのエラー修正（RANK_INFOに存在しないランクへの参照を修正）
- FlightPlanner地図タブのレイヤー表示問題修正（worldCopyJump設定追加）
- ランクアップ進捗表示の改善（進捗計算ロジックの修正）

### **2026年1月（ファンサイト統一対応）**
- WhiskyPapaをファンサイトとして統一
- Home, Header, Footerをファンサイトの文脈で変更
- Aboutページのメンバー紹介（THE CREW）セクションをコメントアウト（復活可能）

### **2026年2月 - 地図機能のACC Sector/RAPCON情報表示拡張**
- **ignore設定の変更**:
  - `.cursorignore` から `public/geojson/` を削除（Cursorでの編集・検索が可能に）
  - `.gitignore` から `public/geojson/` を削除（Git管理対象に）
- **地図ポップアップ機能**:
  - ACC Sector High/Low、RAPCONレイヤーをクリック時に、周波数・高度範囲をポップアップ表示
  - 表示項目: Callsign、VHF/UHF周波数、高度範囲（Floor-Ceiling）
- **GeoJSONプロパティ構造**:
  - `ACC_Sector_High.geojson`、`ACC_Sector_Low.geojson`、`RAPCON.geojson` の全featureに以下のプロパティを追加
  - `Freq_VHF`、`Freq_UHF`、`Floor`、`Ceiling`（AIP等の資料を参照して値を入力）
- **関連ファイル**: `src/pages/planning/components/map/popups/airspacePopup.ts`、`map/types.ts`

### **2026年2月（ファンサイト仕様強化）**
- **Aboutページ**:
  - パイロット紹介（Hero: The Pilot's Portrait）セクションをコメントアウト（本人許可取得後に復活予定）
  - MISSION BRIEFセクションを拡張: サイトの目的・立ち位置（非公式ファンサイト）、利用メリット（無料学習ツール・ファンコミュニティ・ランクシステム）、注意事項（非公式・情報保証なし・著作権配慮・自己責任）を追加
- **Shopページ**: 公式公認取得後に復活予定のため非表示
  - ナビゲーション・フッターからリンク削除
  - `/shop` アクセス時はホームへリダイレクト
- **Scheduleページ**:
  - Marketing Section（曲技飛行サービス紹介）とFooter Noteをコメントアウト
  - 2026年空のイベントスケジュールを詳細化: 確定4件（小牧基地3/1、空の日エアポートフェス3/7、いしのまき復興マラソン3/15、岩国フレンドシップデー5/3）、例年開催15件（航空自衛隊・海上自衛隊の航空祭、空の日・空の旬間など）

**詳細な変更履歴はGitのコミット履歴を参照してください。**

---

**最終更新**: 2026年2月1日（ファンサイト仕様強化）
**バージョン**: Operations & Maintenance Guide v2.0
**管理者**: FlightAcademy開発チーム
