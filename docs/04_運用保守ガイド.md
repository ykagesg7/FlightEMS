# FlightAcademyTsx 運用保守ガイド

## 📋 概要

このドキュメントは、FlightAcademyTsxプロジェクトの運用、保守、トラブルシューティング、パフォーマンス最適化について包括的に説明します。

**最終更新**: 2025年9月17日
**バージョン**: Operations & Maintenance Guide v1.2

---

## 🔄 運用のポイント（追加 2025-09-17）

### Articlesページテーマ統一・登録ボタン有効化（v1.2）

#### **テーマシステム統一**
- **effectiveTheme使用**: 全コンポーネントで`theme`から`effectiveTheme`への移行完了
- **HUDスタイル適用**: Dayテーマ（NavyBlue背景、HUDグリーン）、Darkテーマ（コックピット赤色照明）
- **CSS変数活用**: `--hud-primary`、`--hud-secondary`、`--hud-surface`等の統一

#### **登録ボタン機能**
- **遷移実装**: 全登録ボタンが`/auth`ページへ遷移
- **ボタン配置**: ProgressSummaryHeader、ProgressSidebar、EnhancedArticleCard、ArticleDashboard
- **ルーティング**: 既存の`/auth`ルートを使用

#### **デザイン統一**
- **Articlesページ**: NavyBlue背景（`#0b1d3a`）、HUD枠線
- **学習進捗カード**: 統計カード、今日の目標セクション、達成済みバッジ
- **分析カード**: 「更に詳しい学習分析を体験」「もっと詳しい分析を見る」

#### **技術的改善**
- **エラーハンドリング**: `ReferenceError: theme is not defined`の修正
- **パフォーマンス**: `useCallback`による関数メモ化
- **Linter対応**: 型エラー、未使用変数の解消

## 🔄 運用のポイント（追加 2025-08）

- ヘッダーナビの変更: LESSONS ドロップダウン廃止 → `/learning` 直リンク
- Lessons UI 刷新: タブ/検索/タグのURL同期。関連TEST CTAは `/test?contentId=<id>&mode=practice&count=10`
- アニメーション: `animejs` を遅延import。`prefers-reduced-motion` で自動無効化。問題時はブラウザ強制リロードと開発サーバ再起動で復帰
- ルーティング追加: 学習記事の詳細は `/learning/:contentId`（LessonDetailPage）を新設
- 一覧ボタン分岐: 学習記事末尾の「一覧」は `/learning`、記事（Articles）末尾の「一覧」は `/articles` へ遷移
- 航空気象シリーズの追加: 3.3.1（W-1）, 3.3.2（W-2）を追加し、カテゴリは `CPL学科`、サブカテゴリは `航空気象`

### Supabase セキュリティLint対応（2025-08-29）
- 対応内容:
  - `public.v_mapped_questions` を SECURITY INVOKER 化
  - 公開スキーマ上のバックアップ `public.learning_contents_backup` を削除（またはRLS有効化/非公開スキーマへ移動）

```sql
-- ビューは呼び出し元権限で実行（RLSを尊重）
ALTER VIEW public.v_mapped_questions SET (security_invoker = on);

-- バックアップテーブルを削除（残す場合はRLS有効化や private スキーマへ移動）
DROP TABLE IF EXISTS public.learning_contents_backup;
```
### テーマ適用ガイド（Auth/Profile UI）

- Dayテーマ: HUDグリーン（text: `#39FF14`）、Darkテーマ: 赤系（text: `#ff3b3b`）
- 共通トークンは`src/index.css`で管理（`.day`/`.dark`）
  - `--hud-primary`, `--hud-dim`, `--ring`, `--bg`, `--panel`, `--text-primary`
- コンポーネント側の適用指針
  - 文字色: `hud-text`（= `color: var(--hud-primary)`）
  - 入力欄: `hud-input`（枠=`var(--hud-dim)`, focus ring=`var(--ring)`）
  - ボタン: `border-[color:var(--hud-primary)] text-[color:var(--hud-primary)] hover:bg-[color:var(--hud-dim)]`
  - 背景: ルートは `bg-[color:var(--bg)]`、カードは `bg-[color:var(--panel)]`
- 適用済み例
  - `src/pages/AuthPage.tsx`（ログイン/登録/リセット）
  - `src/pages/ProfilePage.tsx`
    - 背景/カード/ボタン/入力をHUDトークンで統一
    - 基本情報の「ロール」は表示のみ（変更不可）
    - セキュリティ/設定/管理者機能の未適用箇所をHUD化

### SupabaseMCPでのprofilesスキーマ確認手順

1. プロジェクトIDを確認: `FlightAcademy (project_id: fstynltdfdetpyvbrswr)`
2. 次のSQLをMCPから実行
```sql
select column_name, data_type, is_nullable, column_default
from information_schema.columns
where table_schema = 'public' and table_name = 'profiles'
order by ordinal_position;
```
3. 出力は `docs/db/profiles_schema.json` に保存（差分レビュー用）
4. 型同期: `src/types/database.types.ts` の `profiles.Row` と齟齬があれば修正

### 管理者機能（ユーザーロール管理）

- 目的: AdminがSupabaseの`profiles.roll`を管理（Student/Teacher/Admin）
- 画面: `プロフィール > 管理者機能 > ユーザーロール管理`
- 機能:
  - `username/email`に対する部分一致検索（空欄なら全件表示）
  - 一覧は`profiles`から`id, username, email, roll`を取得
  - 変更ボタンで`profiles.roll`を更新（行単位のローディングとエラー表示）
- 取得件数: 管理者は全ユーザー表示（`.range(0, 9999)`）。大量件数時はページングへ切替推奨。
- 注意事項:
  - RLS（Row Level Security）が有効であること
  - Admin以外には当セクションは表示されない

### 基本情報フォームのロール取り扱い

- 「ロール」は読み取り専用表示に変更
- 基本情報の保存時は`roll`は送信しない

### 新UI: アカウントセンターとアバターメニュー（2025-09-13）

- 目的: プロフィール/テーマ/セキュリティ/管理を一元化し、ヘッダーの導線を簡素化
- 変更点
  - 新規ルート `GET /account?tab=<overview|profile|security|theme>` を追加
  - 旧 `/profile` は `/account?tab=profile` へリダイレクト
  - ヘッダーのテーマトグルを削除し、アバターメニューに統合
  - アバターメニューはプロフィール画像（`profiles.avatar_url`）を表示。フォールバックはイニシャル
  - メニュー項目: アカウントセンター/プロフィール/セキュリティ/テーマ切替（Day/Dark/Auto）/ログイン・ログアウト

- アカウントセンター構成
  - **overview**: ユーザー概要（表示名/メール/ロール/テーマ）
  - **profile**: 基本情報編集（ユーザー名/フルネーム/Website）をHUDトークンで統一。ロールは表示のみ。
  - **security**: パスワード変更（現在/新規/確認）を提供。Passkey(WebAuthn)は保留（要HTTPS/同一ドメイン）。
  - **theme**: Day/Dark/Autoを即時適用（HUDトークン）

- 実装ファイル
  - `src/components/ui/AvatarMenu.tsx` … ヘッダーメニュー本体（テーマ切替/遷移/ログイン・ログアウト）
  - `src/pages/AccountCenter.tsx` … アカウントセンター（クエリ`tab`でタブ切替）
  - `src/components/layout/AppLayout.tsx` … テーマトグル削除、アバターメニュー導入、`PROFILE`リンク整理
  - `src/App.tsx` … `/account`追加、`/profile`→`/account?tab=profile`リダイレクト

- UI/テーマ
  - 画面/コンポーネントは `--bg`/`--panel`/`--hud-dim`/`--hud-primary` を使用
  - ラベル/見出しは `hud-text`、ボタンは `border-[color:var(--hud-primary)] text-[color:var(--hud-primary)]` を基本とする

- 運用メモ
  - パスワード変更はSupabase Authの`signInWithPassword`による再認証後、`updateUser({ password })`で更新
  - Passkeyは後日実装。導入時は本番HTTPS・ドメイン整合が必須


## 🎯 システム概要

### **目的**
- **自動化システム**: コード変更に伴うドキュメントの自動更新
- **品質保証**: ドキュメントの一貫性と正確性の確保
- **パフォーマンス最適化**: システム全体の性能向上
- **トラブルシューティング**: 問題の迅速な解決

### **主要機能**
- **ファイル監視**: ソースコードの変更を監視
- **自動更新**: 変更に基づくドキュメントの自動更新
- **検証機能**: ドキュメントの整合性チェック
- **Git hooks統合**: コミット前の自動実行

---

## 🔧 自動ドキュメント更新システム

### **システム構成**

#### **ディレクトリ構造**
```
scripts/docs-auto-update/
├── README.md              # システム概要
├── package.json           # 依存関係
├── watch-changes.js       # ファイル監視
├── update-docs.js         # ドキュメント更新
├── validate-docs.js       # 検証機能
├── setup-git-hooks.js     # Git hooks設定
└── test-simple.js         # テスト用スクリプト
```

#### **主要コンポーネント**

**1. ファイル監視システム**
```javascript
// watch-changes.js
const chokidar = require('chokidar');
const { updateDocs } = require('./update-docs');

const watcher = chokidar.watch([
  'src/**/*.{ts,tsx,js,jsx}',
  'docs/**/*.md'
], {
  ignored: /node_modules/,
  persistent: true
});

watcher.on('change', (path) => {
  console.log(`File changed: ${path}`);
  updateDocs(path);
});
```

**2. ドキュメント更新エンジン**
```javascript
// update-docs.js
const fs = require('fs');
const path = require('path');

function updateDocs(changedFile) {
  const fileType = path.extname(changedFile);

  switch (fileType) {
    case '.tsx':
    case '.ts':
      updateComponentDocs(changedFile);
      break;
    case '.md':
      validateMarkdown(changedFile);
      break;
  }
}
```

**3. 検証システム**
```javascript
// validate-docs.js
const { execSync } = require('child_process');

function validateDocs() {
  try {
    // Markdownの構文チェック
    execSync('npx markdownlint docs/**/*.md');

    // リンクの有効性チェック
    execSync('npx markdown-link-check docs/**/*.md');

    console.log('✅ ドキュメント検証完了');
  } catch (error) {
    console.error('❌ ドキュメント検証エラー:', error.message);
    process.exit(1);
  }
}
```

#### **セットアップ手順**

**1. 依存関係のインストール**
```bash
cd scripts/docs-auto-update
npm install
```

**2. Git hooksの設定**
```bash
node setup-git-hooks.js
```

**3. 監視システムの起動**
```bash
# 開発時
npm run watch

# 手動実行
npm run update
```

### **監視対象ファイル**

#### **ソースコード**
- `src/**/*.{ts,tsx,js,jsx}`: Reactコンポーネント
- `src/types/**/*.ts`: 型定義ファイル
- `src/hooks/**/*.ts`: カスタムフック
- `src/utils/**/*.ts`: ユーティリティ関数

#### **ドキュメント**
- `docs/**/*.md`: Markdownドキュメント
- `docs/improvement-proposals/**/*.md`: 改善提案
- `docs/development/**/*.md`: 開発ドキュメント

### **更新プロセス**

**1. 変更検出**
```javascript
watcher.on('change', (path) => {
  console.log(`📝 変更検出: ${path}`);
  analyzeChange(path);
});
```

**2. 変更分析**
```javascript
function analyzeChange(filePath) {
  const fileType = path.extname(filePath);
  const fileContent = fs.readFileSync(filePath, 'utf8');

  const changes = {
    type: fileType,
    content: fileContent,
    timestamp: new Date().toISOString()
  };

  return changes;
}
```

**3. ドキュメント更新**
```javascript
function updateDocumentation(changes) {
  switch (changes.type) {
    case '.tsx':
      updateComponentDocumentation(changes);
      break;
    case '.ts':
      updateTypeDocumentation(changes);
      break;
    case '.md':
      validateDocumentation(changes);
      break;
  }
}
```

---

## ⚡ パフォーマンス改善レポート

### **実行日時**: 2024年1月27日

### **改善内容**

#### **1. TypeScript型システムの修正**
- **問題**: `QuestionType`のインポートエラーによりビルドが失敗
- **解決**: `src/constants.ts`のインポートパスを修正
  - `import { AppContentData, QuestionType } from './types';`
  - → `import { AppContentData, QuestionType } from './types/quiz';`

#### **2. デバッグログの最適化**
- **問題**: 本番環境でも不要なコンソールログが出力される
- **解決**:
  - 環境変数ベースのロガーユーティリティ（`src/utils/logger.ts`）を作成
  - `process.env.NODE_ENV`を`import.meta.env.MODE`に統一
  - 開発環境でのみデバッグ情報を表示するよう修正

#### **3. コード分割の実装**
- **問題**: メインバンドルサイズが1,088.55 kBと大きすぎる
- **解決**:
  - React.lazyを使用した動的インポートを実装
  - Suspenseコンポーネントでローディング状態を管理
  - 手動チャンク分割でライブラリを分離

### **パフォーマンス改善結果**

#### **バンドルサイズの削減**

**改善前**
- メインバンドル: 1,088.55 kB (gzip: 338.15 kB)
- 警告: 500KB以上のチャンクあり

**改善後**
- メインバンドル: 245.07 kB (gzip: 78.56 kB) - **77.5%削減**
- React関連: 176.65 kB (gzip: 58.07 kB)
- 地図関連: 159.86 kB (gzip: 46.74 kB)
- Supabase関連: 115.19 kB (gzip: 32.18 kB)
- UI関連: 89.34 kB (gzip: 31.68 kB)
- ユーティリティ: 64.78 kB (gzip: 22.46 kB)

#### **分割されたチャンク**
1. **react-vendor**: React、React DOM、React Router
2. **map-vendor**: Leaflet、React Leaflet関連
3. **supabase-vendor**: Supabase関連ライブラリ
4. **ui-vendor**: UI コンポーネントライブラリ
5. **utils-vendor**: ユーティリティライブラリ
6. **ページ別チャンク**: 各ページが個別に分離

### **期待される効果**

#### **1. 初期ロード時間の短縮**
- メインバンドルサイズの大幅削減により、初期ロード時間が改善
- 必要なページのみを動的に読み込むため、不要なコードの読み込みを回避

#### **2. キャッシュ効率の向上**
- ライブラリごとに分離されたチャンクにより、アプリケーション更新時にライブラリキャッシュを維持
- ページ別チャンクにより、変更されていないページのキャッシュを維持

#### **3. 開発体験の向上**
- 本番環境でのデバッグログ削除により、コンソールがクリーンに
- 環境別の適切なログ出力により、開発時のデバッグが効率化

---

## 🚀 AI・自動化ツール活用

### **GeminiCLI 対話環境使用ガイド**

#### **概要**
FlightAcademyTsxプロジェクトにGoogle GeminiCLI v0.1.7が正常に構築され、プロジェクト分析と開発支援のための対話環境が利用可能になりました。

#### **基本使用方法**

**1. シンプルな対話**
```bash
# 基本的な質問
echo "TypeScriptの型エラーを解決する方法は？" | gemini

# プロジェクト固有の質問
echo "認証システムの改善提案をしてください" | gemini
```

**2. デバッグモード**
```bash
# 詳細なデバッグ情報を表示
echo "プロジェクト構造を分析してください" | gemini -d
```

**3. インタラクティブモード**
```bash
# 継続的な対話セッション
gemini
```

#### **効果的な質問例**

**Phase 4 開発支援**
```bash
echo "Phase 4（パフォーマンス最適化）の具体的な実装計画を提案してください" | gemini
```

**コード品質改善**
```bash
echo "src/components/ディレクトリの構造最適化を提案してください" | gemini
```

**技術的課題解決**
```bash
echo "React 18のConcurrent Features活用方法を提案してください" | gemini
```

#### **設定詳細**

**現在の設定**
- **モデル**: gemini-2.5-pro（デフォルト）
- **デバッグ**: 有効
- **テレメトリ**: 無効
- **ファイルスキャン**: プロジェクト全体（最大200ディレクトリ）

**設定ファイル**
```json
{
  "defaultModel": "gemini-2.5-pro",
  "debug": true,
  "context": {
    "maxFileSize": "1MB",
    "excludePatterns": [
      "node_modules", "dist", "build", ".next", "*.log", "*.tmp", ".venv"
    ]
  }
}
```

---

## 📚 総合技術ガイド

### **論理プレゼンテーションSQLガイド**

#### **概要**
学習記事「論理プレゼンテーション」で使用されるSQL文の詳細な解説を提供します。

#### **データベース設計の背景**

論理プレゼンテーションにおける情報整理の考え方：
1. **構造化された思考**: 情報を階層的に整理する
2. **論理的な関連性**: データ間の関係を明確にする
3. **効率的な検索**: 必要な情報を迅速に取得する

#### **実践SQL例**
```sql
-- プレゼンテーション構造テーブル
CREATE TABLE presentation_structure (
    id SERIAL PRIMARY KEY,
    section_name VARCHAR(100) NOT NULL,
    section_order INTEGER,
    parent_section_id INTEGER REFERENCES presentation_structure(id),
    content_summary TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- サンプルデータの挿入
INSERT INTO presentation_structure (section_name, section_order, content_summary) VALUES
('導入', 1, 'プレゼンテーションの目的と概要'),
('現状分析', 2, '現在の状況の詳細な分析'),
('課題特定', 3, '特定された問題点の列挙'),
('解決策提案', 4, '具体的な改善案の提示'),
('実行計画', 5, 'ステップバイステップの実装方法'),
('まとめ', 6, '結論と次のアクション');

-- 論理的な情報取得
SELECT
    section_name,
    section_order,
    content_summary,
    CASE
        WHEN section_order <= 2 THEN '問題提起フェーズ'
        WHEN section_order <= 4 THEN '分析・提案フェーズ'
        ELSE '実行・結論フェーズ'
    END as presentation_phase
FROM presentation_structure
ORDER BY section_order;
```

### **手動SQL実行ガイド**

#### **実行手順**

**1. Supabase管理画面へのアクセス**
1. [Supabase](https://supabase.com)にログイン
2. FlightAcademyTsxプロジェクトを選択
3. 左サイドバーから「SQL Editor」を選択

**2. SQL文の実行**
```sql
-- 例: 学習進捗の確認
SELECT
    profiles.username,
    learning_contents.title,
    user_progress.progress_percentage,
    user_progress.last_accessed
FROM user_progress
JOIN profiles ON user_progress.user_id = profiles.id
JOIN learning_contents ON user_progress.content_id = learning_contents.id
WHERE user_progress.progress_percentage > 50
ORDER BY user_progress.last_accessed DESC;
```

**3. 安全な実行のためのチェックリスト**
- [ ] SELECT文から開始する（データの確認）
- [ ] WHERE句で対象を限定する
- [ ] 本番データに影響する前にテスト環境で確認
- [ ] バックアップの確認

### **MarkItDownセットアップガイド**

#### **概要**
MarkItDownは、様々なファイル形式をMarkdown形式に変換するPythonライブラリです。FlightAcademyTsxでは、学習コンテンツの作成と管理に使用されます。

#### **インストール手順**

**1. Python環境の確認**
```bash
python --version
# Python 3.8以上が必要
```

**2. MarkItDownのインストール**
```bash
pip install markitdown
```

**3. 依存関係のインストール**
```bash
# PDFサポート用
pip install pymupdf

# Officeドキュメントサポート用
pip install python-docx openpyxl

# 画像処理用
pip install pillow
```

#### **基本的な使用方法**

**Python スクリプトでの使用例**
```python
from markitdown import MarkItDown

# MarkItDownインスタンスの作成
md = MarkItDown()

# PDFファイルをMarkdownに変換
with open('document.pdf', 'rb') as f:
    result = md.convert(f)
    print(result.text_content)

# WordファイルをMarkdownに変換
with open('document.docx', 'rb') as f:
    result = md.convert(f)
    print(result.text_content)
```

---

## 🔍 トラブルシューティングガイド

### **React コンポーネント トラブルシューティング**

#### **1. ルーティングエラー: ページが見つかりません**

**症状**
```
ページが見つかりません
```

**原因**
React Router の設定において、該当するパスへのルート定義が `src/App.tsx` に存在しないため。

**解決策**
```jsx
// src/App.tsx
// ページのlazyインポート
const AuthPage = lazy(() => import('./pages/AuthPage'));

// ルート定義
<Routes>
  <Route path="/" element={<AppLayout />}>
    <Route index element={<PlanningMapPage />} />
    <Route path="learning" element={<LearningPage />} />
    <Route path="articles" element={<ArticlesPage />} />
    <Route path="profile" element={<ProfilePage />} />
    <Route path="auth" element={<AuthPage />} /> {/* 追加 */}
    <Route path="test" element={<ArticleStatsTestPage />} /> {/* 追加 */}
    <Route path="*" element={<NotFoundPage />} />
  </Route>
</Routes>
```

#### **2. 一般的なエラー: 未使用の関数や変数**

**症状**
```
'functionName' is declared but its value is never read.
```

**解決策**
- 不要な関数や変数を削除する
- 将来的に使用する可能性がある場合は、一時的にコメントアウトまたは `// @ts-ignore` を使用する

#### **3. レンダリングエラー: MDX CalloutBox未定義**

**症状**
```
Uncaught Error: Expected component `CalloutBox` to be defined: you likely forgot to import, pass, or provide it.
```

**解決策**
`src/components/MDXContent.tsx` の `components` オブジェクトに以下のようなマッピングを追加：
```jsx
CalloutBox: MDXComponents.CalloutBox,
```

#### **4. Hooks 使用順序エラー**

**症状**
```
Warning: Do not call Hooks inside useEffect(...), useMemo(...), or other built-in Hooks.
```

**解決策**
- Hooks は常にコンポーネントのトップレベルで呼び出す
- 非同期処理や条件付き処理の場合は、処理を別関数に切り出し、トップレベルでHooksを呼び出す

#### **5. 状態管理の問題**

**症状**
```
Warning: Cannot update a component while rendering a different component.
```

**解決策**
- 状態更新は必ずイベントハンドラかuseEffect内で行う
- useEffectの依存配列を適切に設定する
- memo関数を使用して不要な再レンダリングを防ぐ

### **認証関連のトラブルシューティング**

#### **1. 認証状態の不整合**

**症状**
- ログインしているにも関わらず、一部のコンポーネントで「未ログイン」と表示される
- 認証状態が異なるコンポーネント間で同期されない

**解決方法**
```typescript
// 古い方法（AuthContext）
import { useAuth } from '../../contexts/AuthContext';
const { user } = useAuth();

// 新しい方法（AuthStore）
import { useAuthStore } from '../../stores/authStore';
const user = useAuthStore(state => state.user);
```

#### **2. Supabaseクライアントの重複インスタンス警告**

**症状**
```
Multiple GoTrueClient instances detected in the same browser context.
```

**解決方法**
```typescript
// src/utils/supabase.ts
let browserSupabaseClient: ReturnType<typeof createBrowserClient<Database>> | undefined;

export const createBrowserSupabaseClient = () => {
  if (!browserSupabaseClient) {
    browserSupabaseClient = createBrowserClient<Database>(supabaseUrl, supabaseKey, {
      auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: true,
        storageKey: 'supabase.auth.token',
      },
    });
  }
  return browserSupabaseClient;
};
```

#### **3. いいね・コメント機能が動作しない**

**症状**
- いいねボタンが押せない
- コメント投稿ができない
- エラーメッセージが表示される

**解決方法**
```sql
-- RLSポリシーの確認
CREATE POLICY "Users can insert their own likes" ON learning_content_likes
FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can insert their own comments" ON learning_content_comments
FOR INSERT WITH CHECK (auth.uid() = user_id);
```

```typescript
// エラーハンドリングの改善
try {
  const { data, error } = await supabase
    .from('learning_content_likes')
    .insert({ content_id: contentId, user_id: user.id });

  if (error) {
    console.error('いいね追加エラー:', error);
    throw error;
  }
} catch (error) {
  alert(`いいねの更新に失敗しました: ${error.message}`);
}
```

#### **4. プロフィール情報が取得できない**

**解決方法**
```typescript
export const getProfileWithRetry = async (userId: string) => {
  const maxRetries = 3;
  let retryCount = 0;

  while (retryCount <= maxRetries) {
    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();

    if (!error) return { data, error: null };

    retryCount++;
    if (retryCount <= maxRetries) {
      await new Promise(resolve => setTimeout(resolve, 500 * retryCount));
    }
  }

  return { data: null, error: new Error('プロフィール取得に失敗しました') };
};
```

---

## 📊 運用・監視

### **パフォーマンス監視**

#### **Core Web Vitals**
- **LCP (Largest Contentful Paint)**: < 2.5秒
- **FID (First Input Delay)**: < 100ms
- **CLS (Cumulative Layout Shift)**: < 0.1

#### **バンドルサイズ**
- **初期バンドル**: < 500KB
- **動的チャンク**: < 200KB
- **総バンドルサイズ**: < 2MB

#### **レンダリング性能**
- **初回レンダリング**: < 1秒
- **インタラクション応答**: < 100ms
- **メモリ使用量**: < 100MB

### **品質保証**

#### **自動検証**
- **Markdown構文**: 構文エラーの検出
- **リンク有効性**: 壊れたリンクの検出
- **一貫性**: ドキュメント間の一貫性チェック

#### **手動検証**
- **内容確認**: 更新内容の正確性確認
- **形式確認**: ドキュメント形式の確認
- **関連性確認**: 関連ドキュメントとの整合性

### **使用方法**

#### **開発時**
```bash
# 監視モードで起動
npm run watch

# 開発サーバーと並行実行
npm run dev & npm run watch
```

#### **コミット前**
```bash
# 手動更新
npm run update

# 検証実行
npm run validate
```

#### **CI/CD統合**
```yaml
# GitHub Actions例
- name: Update Documentation
  run: |
    cd scripts/docs-auto-update
    npm run update
    npm run validate
```

---

## 🛠️ メンテナンス手順

### **定期メンテナンス**

#### **日次チェック**
- [ ] システムの稼働状況確認
- [ ] エラーログの確認
- [ ] バックアップの確認

#### **週次チェック**
- [ ] パフォーマンス指標の確認
- [ ] セキュリティアップデートの確認
- [ ] ドキュメントの整合性確認
- [ ] セキュリティログの確認
- [ ] 認証失敗回数の監視

#### **月次チェック**
- [ ] 依存関係の更新
- [ ] セキュリティ監査
- [ ] パフォーマンス最適化の評価
- [ ] セキュリティ設定の見直し
- [ ] ユーザーセキュリティ教育の実施

### **緊急時対応**

#### **システム障害時**
1. **障害の確認**: エラーログとモニタリング情報の確認
2. **影響範囲の特定**: 影響を受ける機能の特定
3. **緊急復旧**: 最低限の機能を復旧
4. **根本原因の調査**: 障害原因の詳細調査
5. **恒久対策の実施**: 再発防止策の実装

#### **セキュリティインシデント時**
1. **即座の対応**: 影響範囲の特定と一時的なアクセス制限
2. **詳細調査**: ログ分析と攻撃手法の特定
3. **復旧作業**: 脆弱性修正とシステム復旧
4. **再発防止**: 根本原因の特定と恒久対策の実装
5. **ユーザー通知**: 影響を受けたユーザーへの適切な通知

#### **パフォーマンス劣化時**
1. **パフォーマンス指標の確認**: Core Web Vitals等の確認
2. **ボトルネックの特定**: プロファイリングツールでの分析
3. **即座に可能な対策**: キャッシュクリア、不要なプロセス停止
4. **コード最適化**: パフォーマンス問題のあるコードの修正
5. **継続監視**: 改善効果の監視

---

## 🔒 セキュリティ管理戦略

### **現在のセキュリティ状況**

#### **実装済みセキュリティ機能**
- **RLS（Row Level Security）**: 全テーブルで有効化
- **認証システム**: Supabase Authによる安全な認証
- **HTTPS通信**: 全通信の暗号化
- **環境変数管理**: 機密情報の安全な管理

#### **検出されたセキュリティ課題**
- **SECURITY DEFINERビュー**: `learning_progress_integration`ビューを削除済み
- **Leaked Password Protection**: Freeプラン制限により未実装

### **セキュリティ強化計画**

#### **短期計画（1-2ヶ月）**
1. **パスワード強度要件の強化**
   - 最小8文字、大文字・小文字・数字必須
   - フロントエンドでのパスワード強度チェック実装
   - ユーザー向けセキュリティガイドの作成

2. **認証試行回数制限の実装**
   - IPアドレスベースの試行回数制限
   - アカウントロック機能の実装
   - セキュリティログの記録

3. **セッション管理の強化**
   - セッション有効期限の設定
   - 古いセッションの自動削除
   - セッション監視機能の実装

#### **中期計画（3-6ヶ月）**
1. **一般的な弱いパスワードのブロック**
   - データベースレベルでの弱いパスワード検出
   - カスタムパスワード強度チェック関数の実装
   - パスワード変更の強制機能

2. **セキュリティ監査の自動化**
   - 定期的なセキュリティスキャンの実装
   - 脆弱性検出の自動通知
   - セキュリティレポートの自動生成

3. **ユーザー教育プログラム**
   - セキュリティベストプラクティスの共有
   - 定期的なセキュリティアラート
   - セキュリティ意識向上のためのコンテンツ提供

#### **長期計画（6ヶ月以上）**
1. **Proプランへのアップグレード検討**
   - Leaked Password Protection機能の有効化
   - より高度なセキュリティ機能の利用
   - セキュリティ監査レポートの詳細化

2. **多要素認証（MFA）の実装**
   - TOTP（Time-based One-Time Password）の実装
   - SMS認証の追加
   - バックアップ認証方法の提供

3. **セキュリティインシデント対応体制の構築**
   - インシデント検出システムの実装
   - 緊急時対応手順の整備
   - セキュリティチームの体制構築

### **セキュリティ監視項目**

#### **日常監視**
- 認証失敗回数の監視
- 異常なアクセスパターンの検出
- セッション数の監視
- エラーログの確認

#### **定期監査**
- 月次セキュリティレビュー
- 四半期セキュリティ監査
- 年次セキュリティ評価

### **緊急時対応手順**

#### **セキュリティインシデント発生時**
1. **即座の対応**
   - 影響範囲の特定
   - 一時的なアクセス制限
   - セキュリティチームへの通知

2. **詳細調査**
   - ログの詳細分析
   - 攻撃手法の特定
   - 影響度の評価

3. **復旧作業**
   - 脆弱性の修正
   - システムの復旧
   - ユーザーへの通知

4. **再発防止**
   - 根本原因の特定
   - 恒久対策の実装
   - セキュリティ強化の実施

---

## 📈 パフォーマンス最適化戦略

### **最適化手法**

#### **フロントエンド最適化**
- **コード分割**: React.lazyによる動的インポート
- **バンドル最適化**: 手動チャンク分割
- **キャッシュ戦略**: 効率的なキャッシュ利用
- **画像最適化**: WebP形式、遅延読み込み

#### **バックエンド最適化**
- **データベース最適化**: インデックス設計、クエリ最適化
- **API最適化**: レスポンス時間の短縮
- **キャッシュ戦略**: Redis等の活用

### **継続的改善**

#### **監視項目**
- Core Web Vitals
- バンドルサイズ
- API レスポンス時間
- エラー率

#### **改善サイクル**
1. **測定**: パフォーマンス指標の定期測定
2. **分析**: ボトルネックの特定
3. **改善**: 最適化の実施
4. **検証**: 改善効果の確認

---

## 📚 関連リソース

### **外部ドキュメント**
- [React 18 Documentation](https://react.dev/)
- [Vite Documentation](https://vitejs.dev/)
- [Supabase Documentation](https://supabase.com/docs)
- [Tailwind CSS Documentation](https://tailwindcss.com/docs)

### **内部ドキュメント**
- **プロジェクト概要ガイド**: プロジェクト概要、機能詳細
- **技術開発ガイド**: 技術スタック、開発環境
- **計画改善ロードマップ**: 開発計画、改善提案

### **ツール・ユーティリティ**
- **自動ドキュメント更新**: scripts/docs-auto-update/
- **パフォーマンス測定**: Web Vitals, Lighthouse
- **GeminiCLI**: AI支援開発ツール

---

## 🧭 運用手順: 記事（MDX）をSupabaseに公開する（Articles連携）

### 運用概要
- 目的: `src/content` の MDX を Supabase（`learning_contents`）に登録し、`/articles` で公開する
- 対象: 記事ID `1.13_DebriefingMentality`（今回の追加）ほか

### 前提チェック
1. MDX ファイル名（拡張子なし）が `learning_contents.id` と一致していること
2. カテゴリが Articles 対象（『メンタリティー』『思考法』『操縦』）に合致
3. `is_published = true`

### リリース手順（SupabaseMCP）
1. プロジェクト確認: `FlightAcademy (project_id: fstynltdfdetpyvbrswr)`
2. 以下のUpsert SQLを実行

```sql
INSERT INTO learning_contents (
  id, title, category, description, order_index,
  parent_id, content_type, is_published, is_freemium,
  created_at, updated_at
) VALUES (
  '1.13_DebriefingMentality',
  '【メンタリティー】夢をかなえるゾウ、ガネーシャの喝！愛の説教タイムや！【特濃・文字数無制限版】',
  'メンタリティー',
  'デブリーフィングを地獄の説教部屋から成長のパーティ会場に変えるための具体策と心理学。受け身の被告人から主体的な主演兼・監督へ。',
  113,
  null,
  'article',
  true,
  false,
  now(),
  now()
)
ON CONFLICT (id) DO UPDATE SET
  title = EXCLUDED.title,
  category = EXCLUDED.category,
  description = EXCLUDED.description,
  order_index = EXCLUDED.order_index,
  content_type = EXCLUDED.content_type,
  is_published = EXCLUDED.is_published,
  is_freemium = EXCLUDED.is_freemium,
  updated_at = now();
```

3. 確認クエリ
```sql
SELECT id, title, category, is_published, updated_at
FROM learning_contents
WHERE id = '1.13_DebriefingMentality';
```

### ロールバック
- `is_published=false` に更新、またはレコード削除（履歴維持は `is_published` 更新を推奨）

### 運用上の注意
- `MDXLoader` は UUID 形式の ID を未サポート。MDXはファイル名ベースで読み込まれるため、DBの `id` とファイル名を常に一致させる。
- カテゴリ追加時は `ArticlesPage.tsx` の対象カテゴリリストを調整。
- 大量反映は `src/utils/mdxToSupabase.ts` を利用（Node実行）。

---

## 🧭 運用手順: 学習記事（CPL学科・航空気象/Wシリーズ）を公開する（Learning連携）

### 運用概要
- 目的: `src/content/3.3.x_*.mdx` を Supabase（`learning_contents`）に登録し、`/learning` で公開
- 対象: 航空気象シリーズ（W-1, W-2）

### 前提チェック
1. MDX ファイル名（拡張子なし）が `learning_contents.id` と一致していること（例: `3.3.1_StandardAtmosphere`）
2. カテゴリは `CPL学科`、サブカテゴリは `航空気象`
3. `is_published = true`

### リリース手順（SupabaseMCP）
1. プロジェクト確認: `FlightAcademy (project_id: fstynltdfdetpyvbrswr)`
2. 以下のUpsert SQLを実行（W-1, W-2例）

```sql
INSERT INTO learning_contents (
  id, title, category, sub_category, description, order_index,
  parent_id, content_type, is_published, is_freemium,
  created_at, updated_at
) VALUES
(
  '3.3.1_StandardAtmosphere',
  '【航空気象 Mission W-1】標準大気と大気構造 - 我々が飛ぶ『海』の正体',
  'CPL学科',
  '航空気象',
  'ISAの基礎、気圧・気温・密度、対流圏/成層圏の構造を操縦に直結する視点で解説。',
  331,
  NULL,
  'article',
  TRUE,
  FALSE,
  now(),
  now()
),
(
  '3.3.2_CloudsAndPrecipitation',
  '【航空気象 Mission W-2】雲と降水のメカニズム - 天からのサインを読め',
  'CPL学科',
  '航空気象',
  '雲の生成、上昇要因（地形/対流/前線/収束）、併合/氷晶過程と危険気象の読み方。',
  332,
  NULL,
  'article',
  TRUE,
  FALSE,
  now(),
  now()
)
ON CONFLICT (id) DO UPDATE SET
  title = EXCLUDED.title,
  category = EXCLUDED.category,
  sub_category = EXCLUDED.sub_category,
  description = EXCLUDED.description,
  order_index = EXCLUDED.order_index,
  content_type = EXCLUDED.content_type,
  is_published = EXCLUDED.is_published,
  is_freemium = EXCLUDED.is_freemium,
  updated_at = now();
```

3. 確認クエリ
```sql
SELECT id, title, category, sub_category, is_published, updated_at
FROM learning_contents
WHERE id IN ('3.3.1_StandardAtmosphere', '3.3.2_CloudsAndPrecipitation');
```

### 画面反映要件
- `LearningPage.tsx` は `3.3.*` を「航空気象」としてタグ推定・フィルタ表示
- 学習カードは `/learning/:contentId` へ遷移（`LessonCard.tsx`）
- 記事末尾の「一覧」ボタンは文脈で遷移先を分岐（Learning→`/learning`、Articles→`/articles`）

---

## 変更履歴（2025-09-14）

### フロントエンド: テスト結果保存まわりの修正
- `src/pages/TestPage.tsx`
  - `user_test_results` へのINSERT時に、`unified_question_id` が UUID 形式でない場合は `null` を送るように修正。
  - エラーハンドリングを改善し、詳細エラーをUI/コンソールに表示。
- 影響: フロントからの保存処理は後述のDBトリガー改修とセットで動作。

### データベース: トリガー関数の不整合修正
- 対象プロジェクト: `fstynltdfdetpyvbrswr`（FlightAcademy）
- 問題: `user_test_results` の AFTER INSERT トリガー `update_user_weak_areas()` が、
  `user_weak_areas` に存在しないカラム（`total_attempts` 等）を参照し 42703 を発生。
- 対応: 関数を現行スキーマに合わせて再定義。
  - 集計: ユーザー×科目で `attempt_count` と `accuracy_rate` を算出。
  - NULLガード: `NEW.subject_category IS NULL` の場合は処理スキップ（23502回避）。
  - 更新: `ON CONFLICT (user_id, subject_category, sub_category)` で upsert。

### UI: ヘッダーブランドの最適化
- `src/components/layout/AppLayout.tsx`
  - ヘッダー左のブランド表示をロゴアイコン中心に変更。
  - タイトル文字は非表示。画像内に「Flight Academy」文字を含むためロゴのみ提示。
  - サイズ調整: デスクトップ 48px（`w-12 h-12`）、モバイル 40px（`w-10 h-10`）。

### 検証手順
1) ログインし、`/test` で10問解答→結果画面。
2) Network で `POST /rest/v1/user_test_results` が 200/201 であることを確認。
3) Supabase テーブル確認:
   - `user_test_results`: 当該ユーザーの行が追加されていること。
   - `user_weak_areas`: `attempt_count`/`accuracy_rate` が更新されていること。
4) ヘッダー表示確認: ロゴのみ表示、背景透過PNGを使用するとUIと自然に馴染む。

### 既知事項
- アイコン背景は画像ファイル依存。透過が必要な場合は `public/images/icon.png` を透過版に差し替え。

---

**最終更新**: 2025年9月14日
**バージョン**: Operations & Maintenance Guide v1.1
**管理者**: FlightAcademy開発チーム

---

### Git/PowerShell 運用ルール（2025-09-15 追加）

- 基本原則（PowerShell）
  - コマンドは1つずつ実行する（`&&`/`||` の連結は使わない）
  - ページャ無効化: `$env:GIT_PAGER = "cat"` または `git -c core.pager=cat <cmd>`
- 作業ブランチ運用（推奨）
  - 新規: `git switch -c feat/<topic>` → 変更 → `git add -A` → `git commit -m "..."`
  - 初回push: `git push -u origin feat/<topic>`（以降は `git push`）
  - 反映はPRで `origin/main` にマージ（直pushは緊急時のみ）
- main直反映フロー（必要時）
  - `git checkout main`
  - `git pull --rebase origin main`
  - 変更 → `git add -A` → `git commit -m "..."` → `git push origin main`
- rebase/Detached対処
  - rebase中に気づいたら: `git rebase --abort` で復旧
  - Detached HEAD 回避: 必ず `git switch <branch>` でブランチ上で作業
- 反映確認チェック
  - 現在ブランチ: `git rev-parse --abbrev-ref HEAD`
  - 上流追跡: `git branch -vv`（`[origin/<branch>]` を確認）
  - 最新コミット: `git log --oneline -1`
- よくあるトラブルと対処
  - 出力が止まる: ページャが起動 → `-c core.pager=cat` を付与
  - 一時的な接続断: 再試行。`git pull --rebase` の後に `git push`
