# FlightAcademyTsx プロジェクト概要ガイド

## 📋 プロジェクト概要

FlightAcademyTsxは、航空機パイロット向けの包括的な学習・計画プラットフォームです。React+TypeScript+Supabaseを基盤とし、学習コンテンツ管理、進捗・テスト連携、ソーシャル機能、フリーミアム公開、認証、SPAルーティング、パフォーマンス最適化などを実現しています。

**最終更新**: 2025年1月15日
**バージョン**: Project Overview Guide v1.3

---

## 🎯 主な機能

### **学習コンテンツ管理**（MDXベース、カテゴリ・進捗・タグ管理）
- **MDXベースの記事システム**: Markdown + JSX形式で学習記事を管理
- **カテゴリー管理**: 基礎知識、メンタリティー、技術、実践の4カテゴリ
- **進捗管理**: ユーザー別の詳細な学習進捗トラッキング
- **タグ管理**: 記事の分類・検索機能

### **進捗・テスト連携**（CPL試験システム統合、学習-テストマッピング、進捗ダッシュボード）
- **CPL試験システム統合**: 学習記事とテスト問題の連携
- **学習-テストマッピング**: 記事内容と試験問題の関連付け
- **進捗ダッシュボード**: 学習状況の可視化

### **ソーシャル機能**（いいね・コメント、ユーザープロフィール、ロール管理）
- **いいね・コメント機能**: 学習記事にTwitterライクなソーシャル機能
- **ユーザープロフィール**: アバター設定、プロフィール管理
- **ロール管理**: Student/Teacher/Admin の権限管理

### **フリーミアム公開**（一部記事の無料公開、未ログインユーザー向け制御）
- **一部記事無料公開**: 1.4, 1.5, 1.6記事等を無料で提供
- **アクセス制御**: 未ログインユーザー向けの適切な制限
- **ログイン促進**: 制限コンテンツへのアクセス時のログイン誘導

### **シリーズ順次アンロック機能**（ゲーミフィケーション要素、2025年11月2日実装）
- **順次解放システム**: シリーズ記事を1話から順に読了で解放
- **未ログインユーザー**: 各シリーズの1話のみ閲覧可能
- **ログインユーザー**: 直前話の読了で次話が自動解放
- **進捗管理**: スクロール進捗の自動保存、95%到達で完了判定

### **認証**（Zustand+Supabase Auth、メール/パスワード、今後OAuth拡張予定）
- **メール/パスワード認証**: 基本的な認証機能
- **セッション管理**: 自動セッション更新、永続化
- **OAuth拡張予定**: Google、GitHub等の外部認証対応予定

### **SPAルーティング**（React Router、遅延読み込み、404対応）
- **React Router実装**: `/`, `/learning`, `/articles`, `/profile`, `/auth`, `/test`
- **コード分割**: React.lazyによる動的インポート
- **404ハンドリング**: 未定義パスの適切な処理

### **パフォーマンス最適化**（仮想化、遅延読み込み、Vite/Babel最適化、Core Web Vitals指標）
- **仮想化システム**: react-windowによる大量データの効率的表示
- **バンドル最適化**: 77.5%のバンドルサイズ削減を達成
- **Core Web Vitals対応**: LCP < 2.5秒、FID < 100ms、CLS < 0.1

### **フライトプランニング**（インタラクティブ地図、空港情報、航空気象データ統合）
- **インタラクティブ地図**: Leaflet.jsベースの航空地図表示
- **空港・NAVAID情報**: GeoJSON形式の地理データ管理
- **一般気象情報**: WeatherAPI.comによるリアルタイム気象データ取得
- **METAR/TAF統合**: NOAA Aviation Weather Center APIによる航空気象情報
  - リアルタイムMETAR（定時飛行場実況気象通報式）
  - TAF予報（飛行場予報）
  - フライトカテゴリー表示（VFR/MVFR/IFR/LIFR）
  - 日本国内主要空港対応（ICAOコードRJ始まり）
- **サーバーサイドプロキシ**: CORS問題の解決とAPI呼び出しの最適化

---

## 🏗️ 技術スタック

### **フロントエンド**
- **React 18**: Concurrent Mode、Suspense、useTransition
- **TypeScript**: 型安全性、開発効率向上
- **Vite**: 高速ビルドツール、動的チャンク分割
- **Tailwind CSS**: ユーティリティファーストCSS
- **Zustand**: 軽量状態管理
- **React Query**: サーバー状態管理

### **バックエンド**
- **Supabase**: データベース、認証、リアルタイム機能
- **PostgreSQL**: リレーショナルデータベース
- **Edge Functions**: サーバーサイド処理

### **地図・ナビゲーション**
- **Leaflet**: インタラクティブ地図ライブラリ
- **React-Leaflet**: React用Leafletラッパー
- **GeoJSON**: 地理データ形式

### **外部API統合**
- **WeatherAPI.com**: 一般気象情報取得
- **NOAA Aviation Weather Center API**: 航空気象データ（METAR/TAF）取得
  - 認証不要・完全無料
  - サーバーサイドプロキシ経由でCORS問題を回避
  - 日本国内主要空港対応

### **テスト・CI/CD**
- **Vitest / React Testing Library**: テスト実行とUIテスト
- **ESLint / Prettier**: 静的解析と整形
- **GitHub Actions**: CI/CD（詳細は技術開発ガイドに統合）

---

## 📚 詳細機能ガイド（抜粋）

MDX/Articlesの実装・連携手順、サポートコンポーネントは「02_技術開発ガイド.md」に集約しました。本ガイドでは概要のみを保持します。

### **ソーシャル機能詳細**

#### **いいね機能**
```typescript
interface Like {
  id: string;
  content_id: string;
  user_id: string;
  created_at: string;
}
```

- リアルタイムでのいいね数更新
- ユーザーごとの重複いいね防止
- ダークモード対応UI
- ログイン必須機能

#### **コメント機能**
```typescript
interface Comment {
  id: string;
  content_id: string;
  user_id: string;
  content: string;
  created_at: string;
  updated_at: string;
  profiles?: {
    username: string;
    full_name: string;
  };
}
```

- マルチライン対応のコメント投稿
- ユーザープロフィール情報の表示
- 投稿日時の表示
- レスポンシブデザイン

### **認証システム（概要）**
- Supabase Auth + Zustand による認証（詳細実装は技術開発ガイド）

### **ルーティングシステム詳細**

#### **主要ルート構成（更新: 2025-09）**
| パス | コンポーネント | 説明 |
|------|---------------|------|
| `/` | HomePage | 新ホーム（ランディング/CTA/導線） |
| `/planning` | PlanningMapPage | 飛行計画マップ |
| `/learning` | LearningPage | 学習コンテンツ一覧・閲覧 |
| `/learning/:contentId` | LessonDetailPage | 学習記事の詳細（文脈はlearning） |
| `/articles` | ArticlesPage | 記事一覧・検索 |
| `/articles/:contentId` | ArticleDetailPage | 記事詳細（文脈はarticles） |
| `/profile` | ProfilePage | ユーザープロフィール管理 |
| `/auth` | AuthPage | 認証（ログイン・登録、`mode=signup|reset`対応） |
| `/test` | ArticleStatsTestPage | 記事統計・テスト機能 |

---

## 🔄 最近の変更（2025-09）

- 新ホームページ（`/`）を導入し、登録促進のランディング構成（Hero→機能→体験導線→ソーシャルプルーフ→最終CTA）を実装
- 旧トップの計画マップは `/planning` に移動。ヘッダーの PLANNING は `/planning` に遷移
- 認証ページで `?mode=signup|reset` を解釈し、登録/リセット画面を直接表示可能に
- ヘッダーに `HOME` を追加（PC/モバイル）し、主要導線を明確化

## 🔄 最近の変更（2025-08）

- Lessons 体験を Articles と同等の検索・タグ・URL同期へ刷新
  - カテゴリタブ（A11y対応）、検索、タグを導入し、状態を URL に同期
  - レッスンカードを共通化（進捗リング、関連TEST CTA、スクロールイン演出）
- ヘッダーナビの簡素化
  - ヘッダーの「LESSONS」プルダウンを廃止し、`/learning` への直接リンクのみ
  - ページ内タブ/検索でナビゲーションを完結
- アニメーション基盤
  - anime.js を遅延 import で導入（`prefers-reduced-motion` 準拠）
  - スクロールイン/進捗アニメを軽量に実装

#### **技術的特徴（概要）**
- React.lazy/Suspense、ネストルーティング、404ハンドリング（詳細は技術開発ガイド）

---

## 📈 現在の開発状況（要約）

### **Phase 5進行中**
- **ルーティング・認証UI/UXの最適化**: AuthPage・TestPageルート追加完了
- **セキュリティ強化**: APIキー・環境変数管理の完全実装
- **Vite/Babel/React18の最適化**: 動的チャンク分割最適化、Babel重複エラー修正
- **型安全性・テストカバレッジ拡大**: any型削除の段階的実施
- **CPL試験システム統合準備**: 学習-テスト連携基盤の構築

### **品質管理（要約）**
- 型安全性推進、ESLint/Prettier、Vitest、CI/CD（詳細は技術開発ガイド）

### **パフォーマンス実績**
- **バンドルサイズ削減**: 77.5%削減（1,088.55 kB → 245.07 kB）
- **Core Web Vitals**: LCP < 2.5秒、FID < 100ms、CLS < 0.1達成
- **レンダリング最適化**: react-window等で大規模データも高速表示

---

## 🚀 今後の開発計画

### **直近の優先タスク**
1. **学習進捗管理UIの実装強化**
   - 記事ごとの進捗率・完了管理・復習サポートUI
   - ユーザー別進捗トラッキングの詳細化

2. **CPL試験システムの本格統合**
   - 学習-テスト連携、出題傾向分析
   - 優先記事推薦、進捗ダッシュボード
   - CPL合格可能性の予測指標

3. **UI/UXのさらなる改善**
   - サイドバー・アクセシビリティ・ARIA属性強化
   - 記事内検索・ハイライト機能
   - ダークモード・レスポンシブデザイン最適化

4. **AI・モバイル対応**
   - AIによる記事推薦システム
   - React Nativeによるモバイルアプリ化

5. **パフォーマンス・セキュリティの継続的最適化**
   - PWA対応、RLS/認証強化
   - バンドル最適化、Core Web Vitals向上

6. **管理者向け機能拡充**
   - コンテンツ管理・同期機能
   - 外部LMS連携

### **長期的な拡張予定**
- **リアルタイム機能**: Supabase Realtimeを活用したリアルタイム更新
- **通知システム**: いいねやコメントの通知機能
- **検索機能**: 全文検索とフィルタリング
- **分析機能**: 学習進捗の詳細分析
- **記事推薦**: AIベースの個人化記事推薦システム

---

## 📊 主要な成果と改善履歴

### **Phase 4完了成果（2024年-2025年）**

#### **1. 認証機能の完全実装**
- Supabase Auth + Zustand による統一認証システム
- メール/パスワード認証、セッション管理
- プロテクテッドルート、ユーザープロファイル管理

#### **2. Learning機能の大幅拡充**
- サイドバーナビゲーション、ハンバーガーメニュー実装
- 記事の前後移動、一覧戻り機能
- 現在閲覧中記事の強調表示

#### **3. ソーシャル機能とフリーミアム機能**
- いいね・コメント機能の完全実装
- 1.4, 1.5, 1.6記事のフリーミアム設定
- 動的なフリーミアム管理システム

#### **4. CPL航空法シリーズコンテンツ**
- 新カテゴリ追加: CPL航空法シリーズ
- 4記事同時リリース（Mission 0-2）
- MDXシステム・データベースとの完全統合

#### **5. UI/UX大幅改善（2025年1月）**
- 最新記事3つの専用表示セクション
- 記事への直接ジャンプ機能
- ハイライト効果付きナビゲーション
- 全ページ統一グラデーションデザイン

### **技術的改善（抜粋）**

#### **型安全性の向上**
```typescript
// 改善前: any型の使用
const handleAirportSelect = (selectedOption: any) => {
  // ...
};

// 改善後: 型安全な実装
const handleAirportSelect = (selectedOption: AirportGroupOption | null) => {
  if (!selectedOption) return;
  // ...
};
```

#### **パフォーマンス最適化実績**
- **バンドルサイズ**: 77.5%削減（1,088.55 kB → 245.07 kB）
- **チャンク分割**: react-vendor, map-vendor, supabase-vendor等
- **ローディング最適化**: React.lazy + Suspense実装

#### **地図（Map）機能のUI/構造リニューアル（2025-08）**
- HUDテーマの一貫化と可視性向上（半透明黒背景・HUD色のラベル/値・`hud-readout`）
- ポップアップの2カラム化（モバイルは1カラムへ自動スタック）、ラベル上/値下の縦積みテンプレート
- 座標オーバーレイを高コントラストのHUDパネル化
- 空港ポップアップに気象/空港情報を統合し、RWY/標高を確実に表示
- すべてのポップアップに`keepInView`/`autoPan`を適用し、画面外はみ出しを防止
- コード構造の分離:
  - `src/components/map/layers/` に Airports/Navaids/Waypoints を分離
  - `src/components/map/popups/` に共通ビルダー（`escapeHtml`/`kvItem`/`sectionHeader`/`createPopup`）とテンプレートを配置
  - `src/components/map/types.ts` に `AirportProps`/`NavaidProps`/`WaypointProps` を定義し型安全性を向上

#### **セキュリティ強化**
- **環境変数管理**: Weather API、Supabase、Google APIs等の完全環境変数化
- **RLS実装**: Row Level Securityによるデータアクセス制御
- **認証強化**: セッション管理・プロフィール取得の強化

---

## 🎯 品質指標と成功指標（要約）

### **品質指標**
- **型安全性**: any型の段階的削除（目標: 100%型安全）
- **テストカバレッジ**: 80%目標
- **Core Web Vitals**: LCP < 2.5秒、FID < 100ms、CLS < 0.1
- **バンドルサイズ**: 初期バンドル < 500KB、総バンドル < 2MB

### **ユーザーエンゲージメント指標**
- 平均セッション時間の向上
- ページビュー数の増加
- バウンス率の低下
- 機能利用率の向上

### **パフォーマンス指標**
- ページロード時間 < 3秒
- APIレスポンス時間 < 500ms
- エラー率 < 1%
- 可用性 > 99.9%

---

## 🛠️ 開発・品質管理フロー（要約）

### **開発プロセス**
- **型安全性優先**: TypeScript strictモードでの開発
- **テスト駆動**: Vitest + React Testing Libraryによる包括的テスト
- **CI/CD**: GitHub Actionsによる自動化
- **ドキュメント自動更新**: scripts/docs-auto-update/による自動化

### **コード品質管理**
- **ESLint**: TypeScript + React専用ルール
- **Prettier**: 統一されたコードフォーマット
- **Husky**: コミット前の自動チェック
- **型安全性**: any型の完全排除目標

### **リスク管理**
- **技術的リスク**: 新技術採用による複雑性の増加対策
- **プロジェクトリスク**: スケジュール遅延・リソース制約への対応
- **セキュリティリスク**: 定期的なセキュリティ監査

---

## 📚 関連リソース・更新履歴

### **ドキュメント体系**
- **技術開発ガイド**: 技術スタック詳細、開発環境、コントリビューション
- **計画改善ロードマップ**: 開発計画、改善提案、実装進捗
- **運用保守ガイド**: 自動化システム、パフォーマンス、トラブルシューティング
- **設計仕様書**: API仕様、データベース設計、UI/UX仕様

### **重要な更新履歴**
- **2025年11月2日**: Phase 7完了、シリーズ順次アンロック機能実装、新規記事「祝福と諫言」追加
- **2025年1月27日**: Phase 5開始、機密情報管理完了
- **2025年1月21日**: Phase 4完了、UIテーマ・HUDライン仕様変更
- **2024年7月**: CPL航空法シリーズ開始、ソーシャル機能実装
- **2024年6月**: 認証システム統一、フリーミアム機能実装

#### 最新アップデート（2025年8月15日）
- Lessons/Testの最新LMSトレンド対応を適用
  - Testページにモード切替（Practice/Exam/Review）を実装
  - Examモードにタイマー（1問60秒・最小5分）、即時解説ロック、時間切れ自動提出
  - 問題パレット（番号ジャンプ）とフラグ機能を追加
  - ReviewモードでSRS（`user_unified_srs_status`）に基づく「今日の復習」を出題
  - `contentId`深いリンクで記事→テストの連携を強化（`/test?contentId=<id>&mode=practice`）
- Lessonsページにダッシュボードを追加
  - 今日の復習件数、続きから（最近閲覧記事）、おすすめ（弱点科目）を表示
- ルーティング修正：記事詳細ページを新設
  - `ArticleDetailPage` と `/articles/:contentId` を追加
  - MDXファイル（`src/content/<id>.mdx`）を `MDXLoader` で読み込む設計に統一
  - 「ページが見つかりません」問題を解消
- DB拡張（MVP範囲）
  - `user_unified_srs_status`（SRS用）を追加
  - `v_mapped_questions` ビュー（学習記事と統一CPL問題のマッピング取得）を追加
  - `user_test_results.unified_question_id` 列を追加し、`unified_cpl_questions` へFK連携

### **コミット履歴**
- **最新コミット**: 69161de（50ファイル変更、4910行追加、2212行削除）
- **主要改善**: 型安全性向上、パフォーマンス最適化、UI/UX改善

---

## 📞 サポート・コントリビューション

### **問題報告・機能要求**
- GitHub Issues での報告
- 詳細な再現手順の記載
- 環境情報の提供

### **コントリビューション方法**
1. プロジェクトのフォーク
2. 機能ブランチの作成
3. 変更の実装とテスト
4. プルリクエストの提出

### **開発環境セットアップ**
```bash
# リポジトリクローン
git clone https://github.com/your-org/FlightAcademyTsx.git
cd FlightAcademyTsx

# 依存関係インストール
npm install

# 環境変数設定
cp .env.example .env.local
# .env.local に必要な API キーを設定

# 開発サーバー起動
npm run dev
```

---

**最終更新**: 2025年8月11日
**バージョン**: Project Overview Guide v1.0
**管理者**: FlightAcademy開発チーム
